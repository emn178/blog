<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="content-language" content="en"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ancestry vs. awesome_nested_set | emn178's Blog</title><meta name="keywords" content="Programming,Ruby,Ruby on Rails,Tree,closure_tree,Performance,Benchmark,ransack"><meta name="author" content="emn178"><meta name="copyright" content="emn178"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="There are several gems available for handling tree structures in Rails. This article will compare the following solutions:  ancestry awesome_nested_se"><meta property="og:type" content="article"><meta property="og:title" content="ancestry vs. awesome_nested_set"><meta property="og:url" content="https://emn178.github.io/blog/en/post/ancestry-vs-awesome-nested-set/"><meta property="og:site_name" content="emn178&#39;s Blog"><meta property="og:description" content="There are several gems available for handling tree structures in Rails. This article will compare the following solutions:  ancestry awesome_nested_se"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://emn178.github.io/blog/images/logos/Ruby_On_Rails_Logo.svg"><meta property="article:published_time" content="2025-05-17T13:16:57.000Z"><meta property="article:modified_time" content="2025-05-17T13:16:36.733Z"><meta property="article:author" content="emn178"><meta property="article:tag" content="AI,Coding,Programming,Technology"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://emn178.github.io/blog/images/logos/Ruby_On_Rails_Logo.svg"><link rel="shortcut icon" href="/blog/favicon.png"><link rel="canonical" href="https://emn178.github.io/blog/en/post/ancestry-vs-awesome-nested-set/"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/blog/css/index.css?v=26"><link rel="preload" href="/blog/libs/fontawesome-free-6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel=&quot;stylesheet&quot;"><script>const GLOBAL_CONFIG={root:"/blog/",algolia:void 0,localSearch:void 0,translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"Copy successfully",error:"Copy error",noSupport:"The browser does not support"},relativeDate:{homepage:!1,post:!1},runtime:"",date_suffix:{just:"Just",min:"minutes ago",hour:"hours ago",day:"days ago",month:"months ago"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1,percent:{toc:!0,rightside:!1}},delayScripts=[],delayStyles=[],maybeMobile=window.innerWidth<=800;if(delayScripts.push({delay:maybeMobile?1e3:0,src:"/blog/js/lazyload.iife.min.js",onload:()=>initLazyLoad()}),delayScripts.push({delay:maybeMobile?2e3:1e3,src:"/blog/js/fancybox.umd.min.js",onload:()=>runLightbox()}),delayStyles.push({delay:maybeMobile?2e3:1e3,href:"/blog/css/fancybox.min.css"}),delayScripts.push({delay:3e3,src:"/blog/libs/share-js/js/social-share.min.js"}),delayStyles.push({delay:3e3,href:"/blog/libs/share-js/css/share.min.css"}),"localhost:4000"!==location.host){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-P1KZGBXDLG"),gtag({event:"gtm.js","gtm.start":(new Date).getTime(),"gtm.uniqueEventId":0})}function initGTMOnEvent(e){document.removeEventListener(event.type,initGTMOnEvent),initGTM()}function initGTM(){if(window.gtmDidInit)return;window.gtmDidInit=!0;const e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=/blog/G-P1KZGBXDLG",document.head.appendChild(e)}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initGTM,3500)}),document.addEventListener("scroll",initGTMOnEvent),document.addEventListener("mousemove",initGTMOnEvent),document.addEventListener("touchstart",initGTMOnEvent),delayScripts.push({delay:0,src:"//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"})</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"ancestry vs. awesome_nested_set",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-05-17 21:16:36"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><link rel="alternate" href="https://emn178.github.io/blog/zh-TW/post/ancestry-vs-awesome-nested-set/" hreflang="zh-TW" type="text/html"><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)}),e.getCSS=(e,t=!1)=>new Promise((o,n)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=e,t&&(a.id=t),a.onerror=n,a.onload=a.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,o())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="alternate" href="/en/blog/atom.xml" title="小殘的程式光廊" type="application/atom+xml">
<link rel="alternate" href="/en/blog/rss2.xml" title="小殘的程式光廊" type="application/rss+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/blog/images/loading.svg" data-src="/blog/images/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"><noscript><img src="/blog/images/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></noscript></div><div class="sidebar-site-data site-data is-center"><a href="/blog/archives/"><div class="headline">Articles</div><div class="length-num">6</div></a><a href="/blog/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/blog/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/en/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/blog/en/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/blog/en/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/blog/en/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-rss"></i><span> Subscriptions</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/blog/en/atom.xml"><i class="fa-fw fas fa-rss"></i><span> ATOM</span></a></li><li><a class="site-page child" href="/blog/en/rss2.xml"><i class="fa-fw fas fa-rss"></i><span> RSS</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/blog/zh-TW/"><i class="fa-fw fas fa-globe"></i><span> 中文</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/blog/images/logos/Ruby_On_Rails_Logo.svg)"><nav id="nav"><span id="blog-info"><a href="/blog/en/" title="emn178's Blog"><span class="site-name">emn178's Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/en/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/blog/en/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/blog/en/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/blog/en/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-rss"></i><span> Subscriptions</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/blog/en/atom.xml"><i class="fa-fw fas fa-rss"></i><span> ATOM</span></a></li><li><a class="site-page child" href="/blog/en/rss2.xml"><i class="fa-fw fas fa-rss"></i><span> RSS</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/blog/zh-TW/"><i class="fa-fw fas fa-globe"></i><span> 中文</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">ancestry vs. awesome_nested_set</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fas fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-05-17T13:16:57.000Z" title="Created 2025-05-17 21:16:57">2025-05-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-05-17T13:16:36.733Z" title="Updated 2025-05-17 21:16:36">2025-05-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/blog/en/categories/Programming/">Programming</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/blog/en/categories/Programming/Ruby/">Ruby</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="ancestry vs. awesome_nested_set"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>There are several gems available for handling tree structures in Rails. This article will compare the following solutions:</p><ol><li><a target="_blank" rel="noopener" href="https://github.com/stefankroes/ancestry">ancestry</a></li><li><a target="_blank" rel="noopener" href="https://github.com/collectiveidea/awesome_nested_set">awesome_nested_set</a></li><li><a target="_blank" rel="noopener" href="https://github.com/ClosureTree/closure_tree">closure_tree</a></li></ol><h2 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h2><p>Suppose there is a model called <code>Node</code> that can have child nodes in a tree structure.</p><h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><h3 id="ancestry"><a href="#ancestry" class="headerlink" title="ancestry"></a>ancestry</h3><h4 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h4><p>Using the new rules, add the following to config&#x2F;initializers&#x2F;ancestry.rb</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Ancestry</span>.default_ancestry_format = <span class="symbol">:materialized_path2</span></span><br></pre></td></tr></table></figure><p>Tables that need to support a tree structure should include some dedicated columns.</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">create_table <span class="symbol">:nodes</span> <span class="keyword">do</span> |<span class="params">t</span>|</span><br><span class="line">  t.string <span class="symbol">:name</span>, <span class="symbol">null:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># required</span></span><br><span class="line">  t.string <span class="symbol">:ancestry</span>, <span class="symbol">collation:</span> <span class="string">&#x27;C&#x27;</span>, <span class="symbol">null:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># optional extensions</span></span><br><span class="line">  t.integer <span class="symbol">:ancestry_depth</span>, <span class="symbol">default:</span> <span class="number">0</span></span><br><span class="line">  t.integer <span class="symbol">:children_count</span>, <span class="symbol">default:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  t.timestamps</span><br><span class="line"></span><br><span class="line">  t.index <span class="symbol">:ancestry</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>Then, add <code>has_ancestry</code> to the model.</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span> &lt; <span class="title class_ inherited__">ApplicationRecord</span></span><br><span class="line">  <span class="comment"># basic functionality</span></span><br><span class="line">  <span class="comment"># has_ancestry</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># extensions</span></span><br><span class="line">  has_ancestry <span class="symbol">counter_cache:</span> <span class="literal">true</span>, <span class="symbol">cache_depth:</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h4 id="Basic-Usage"><a href="#Basic-Usage" class="headerlink" title="Basic Usage"></a>Basic Usage</h4><p>List the commonly used instance methods</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">node.children</span><br><span class="line">node.ancestors</span><br><span class="line">node.descendants</span><br><span class="line"></span><br><span class="line"><span class="comment"># including self</span></span><br><span class="line">node.siblings</span><br></pre></td></tr></table></figure><p>List the commonly used class methods</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Node</span>.roots</span><br><span class="line"><span class="title class_">Node</span>.children_of(id_or_node)</span><br><span class="line"><span class="title class_">Node</span>.ancestor_of(id_or_node)</span><br><span class="line"><span class="title class_">Node</span>.descendants_of(id_or_node)</span><br><span class="line"><span class="title class_">Node</span>.siblings_of(id_or_node)</span><br></pre></td></tr></table></figure><h4 id="Ransack-Search"><a href="#Ransack-Search" class="headerlink" title="Ransack Search"></a>Ransack Search</h4><p>Use class methods in combination with Ransack.</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">self</span>.ransackable_attributes(_auth_object = <span class="literal">nil</span>)</span><br><span class="line">  <span class="string">%w[ancestry]</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">self</span>.ransackable_scopes(_auth_object = <span class="literal">nil</span>)</span><br><span class="line">  <span class="string">%w[children_of]</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>and then</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Node</span>.ransack(<span class="symbol">children_of:</span> <span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>However, to search for roots, you need to query the ancestry column.</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Node</span>.ransack(<span class="symbol">ancestry:</span> <span class="string">&#x27;/&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="awesome-nested-set"><a href="#awesome-nested-set" class="headerlink" title="awesome_nested_set"></a>awesome_nested_set</h3><h4 id="Setup-1"><a href="#Setup-1" class="headerlink" title="Setup"></a>Setup</h4><p>Tables that need to support a tree structure should include some dedicated columns.</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">create_table <span class="symbol">:nodes</span> <span class="keyword">do</span> |<span class="params">t</span>|</span><br><span class="line">  t.string <span class="symbol">:name</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Required</span></span><br><span class="line">  t.integer <span class="symbol">:parent_id</span>, <span class="symbol">null:</span> <span class="literal">true</span>, <span class="symbol">index:</span> <span class="literal">true</span></span><br><span class="line">  t.integer <span class="symbol">:lft</span>, <span class="symbol">null:</span> <span class="literal">false</span>, <span class="symbol">index:</span> <span class="literal">true</span></span><br><span class="line">  t.integer <span class="symbol">:rgt</span>, <span class="symbol">null:</span> <span class="literal">false</span>, <span class="symbol">index:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># optional extensions</span></span><br><span class="line">  t.integer <span class="symbol">:depth</span>, <span class="symbol">null:</span> <span class="literal">false</span>, <span class="symbol">default:</span> <span class="number">0</span></span><br><span class="line">  t.integer <span class="symbol">:children_count</span>, <span class="symbol">null:</span> <span class="literal">false</span>, <span class="symbol">default:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  t.timestamps</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>Then, add <code>acts_as_nested_set</code> to the model.</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span> &lt; <span class="title class_ inherited__">ActiveRecord::Base</span></span><br><span class="line">  <span class="comment"># Basic functionality</span></span><br><span class="line">  <span class="comment"># acts_as_nested_set</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># extensions</span></span><br><span class="line">  acts_as_nested_set <span class="symbol">counter_cache:</span> <span class="symbol">:children_count</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h4 id="Basic-Usage-1"><a href="#Basic-Usage-1" class="headerlink" title="Basic Usage"></a>Basic Usage</h4><p>List the commonly used instance methods</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">node.children</span><br><span class="line">node.ancestors</span><br><span class="line">node.descendants</span><br><span class="line">node.siblings</span><br></pre></td></tr></table></figure><p>If you want to include self, use a more explicit naming convention.</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node.self_and_ancestors</span><br><span class="line">node.self_and_siblings</span><br><span class="line">node.self_and_descendants</span><br></pre></td></tr></table></figure><p>List the commonly used class methods</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Node</span>.roots</span><br></pre></td></tr></table></figure><h4 id="Ransack-Search-1"><a href="#Ransack-Search-1" class="headerlink" title="Ransack Search"></a>Ransack Search</h4><p>You can directly search using parent_id.</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">self</span>.ransackable_attributes(_auth_object = <span class="literal">nil</span>)</span><br><span class="line">  <span class="string">%w[parent_id]</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>and then</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Node</span>.ransack(<span class="symbol">parent_id:</span> <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># roots</span></span><br><span class="line"><span class="title class_">Node</span>.ransack(<span class="symbol">parent_id:</span> <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure><p>If you need other types of searches, you can define your own scopes to use.</p><h3 id="closure-tree"><a href="#closure-tree" class="headerlink" title="closure_tree"></a>closure_tree</h3><h4 id="Setup-2"><a href="#Setup-2" class="headerlink" title="Setup"></a>Setup</h4><p>Unlike other gems, the setup process is relatively complex and should follow the official documentation step by step. In the end, an additional table will be created to record the tree structure. For example, with the Node model above, another table called <code>node_hierarchies</code> will be generated.</p><h4 id="Basic-Usage-2"><a href="#Basic-Usage-2" class="headerlink" title="Basic Usage"></a>Basic Usage</h4><p>It’s similar to awesome_nested_set, so I won’t repeat it here. However, compared to the first two gems, this one does not store children_count and depth in the database. They are calculated in real time. If you need those features, this gem might not be suitable.</p><h4 id="Ransack-Search-2"><a href="#Ransack-Search-2" class="headerlink" title="Ransack Search"></a>Ransack Search</h4><p>It’s similar to awesome_nested_set, so I won’t repeat it here.</p><h2 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h2><p>Next, let’s test the performance. I created a <a target="_blank" rel="noopener" href="https://github.com/emn178/tree-benchmark">benchmark project</a>, and the results are approximately as follows (reorganized and formatted):</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">---------------------------------</span><br><span class="line">benchmark:create</span><br><span class="line">            ancestry      0.114 (± 0.0%) i/s     (8.79 s/i) -      1.000 in   8.786560s</span><br><span class="line">  awesome_nested_set      0.015 (± 0.0%) i/s    (65.36 s/i) -      1.000 in  65.363601s</span><br><span class="line">        closure_tree      0.051 (± 0.0%) i/s    (19.59 s/i) -      1.000 in  19.585828s</span><br><span class="line">---------------------------------</span><br><span class="line">benchmark:update</span><br><span class="line">            ancestry      0.046 (± 0.0%) i/s    (21.83 s/i) -      1.000 in  21.831982s</span><br><span class="line">  awesome_nested_set      1.203 (± 0.0%) i/s  (831.21 ms/i) -      6.000 in   5.062957s</span><br><span class="line">        closure_tree      0.016 (± 0.0%) i/s    (60.76 s/i) -      1.000 in  60.756249s</span><br><span class="line">---------------------------------</span><br><span class="line">benchmark:children_of</span><br><span class="line">            ancestry      0.522 (± 0.0%) i/s     (1.92 s/i) -      3.000 in   5.757987s</span><br><span class="line">   ancestry (faster)      4.291 (± 0.0%) i/s  (233.02 ms/i) -     22.000 in   5.199553s</span><br><span class="line">  awesome_nested_set      9.551 (±10.5%) i/s  (104.70 ms/i) -     48.000 in   5.047880s</span><br><span class="line">        closure_tree     10.207 (± 9.8%) i/s   (97.97 ms/i) -     51.000 in   5.046494s</span><br><span class="line">---------------------------------</span><br><span class="line">benchmark:children</span><br><span class="line">            ancestry     10.863 (± 9.2%) i/s   (92.06 ms/i) -     53.000 in   5.008058s</span><br><span class="line">  awesome_nested_set      7.913 (±12.6%) i/s  (126.37 ms/i) -     39.000 in   5.035606s</span><br><span class="line">        closure_tree      9.631 (±10.4%) i/s  (103.83 ms/i) -     48.000 in   5.032850s</span><br><span class="line">---------------------------------</span><br><span class="line">benchmark:descendants</span><br><span class="line">            ancestry      6.721 (±14.9%) i/s  (148.79 ms/i) -     33.000 in   5.057038s</span><br><span class="line">  awesome_nested_set      5.415 (± 0.0%) i/s  (184.69 ms/i) -     28.000 in   5.176816s</span><br><span class="line">        closure_tree      1.003 (± 0.0%) i/s  (997.09 ms/i) -      5.000 in   5.013623s</span><br><span class="line">---------------------------------</span><br><span class="line">benchmark:siblings</span><br><span class="line">            ancestry     12.053 (± 8.3%) i/s   (82.97 ms/i) -     61.000 in   5.083198s</span><br><span class="line">  awesome_nested_set      7.683 (± 0.0%) i/s  (130.16 ms/i) -     39.000 in   5.093565s</span><br><span class="line">        closure_tree      9.630 (±10.4%) i/s  (103.84 ms/i) -     48.000 in   5.006542s</span><br><span class="line">---------------------------------</span><br><span class="line">benchmark:ancestors</span><br><span class="line">            ancestry      6.866 (± 0.0%) i/s  (145.64 ms/i) -     35.000 in   5.107056s</span><br><span class="line">  awesome_nested_set      5.957 (± 0.0%) i/s  (167.88 ms/i) -     30.000 in   5.043287s</span><br><span class="line">        closure_tree      0.895 (± 0.0%) i/s     (1.12 s/i) -      5.000 in   5.593123s</span><br><span class="line">---------------------------------</span><br></pre></td></tr></table></figure><p>Although ancestry generally performs better in most cases, its most commonly used feature, <code>children_of</code> (retrieving child nodes by id), is actually the slowest. The official default implementation is about 20 times slower than awesome_nested_set. This is because when executing:</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.children_of(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>Its implementation is:</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.find(<span class="number">1</span>).children</span><br></pre></td></tr></table></figure><p>It executes two queries. The similar class methods work this way. I implemented a single-query version as follows:</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">self</span>.children_of_by_id(id)</span><br><span class="line">  where(<span class="symbol">ancestry:</span> <span class="title class_">Node</span>.where(<span class="symbol">id:</span> id).select(sanitize_sql_array([ <span class="string">&quot;CONCAT(ancestry, ?)&quot;</span>, <span class="string">&quot;<span class="subst">#&#123;id&#125;</span>/&quot;</span> ])))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>The performance improved by about 10 times, but it is still relatively slow.</p><h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h2><p>We compare in a table:</p><table><thead><tr><th>Item</th><th align="center">ancestry</th><th align="center">awesome_nested_set</th><th align="center">closure_tree</th></tr></thead><tbody><tr><td>Features</td><td align="center">O</td><td align="center">O</td><td align="center">△</td></tr><tr><td>Easy to use</td><td align="center">O</td><td align="center">O</td><td align="center">△</td></tr><tr><td>Performance</td><td align="center">O</td><td align="center">O</td><td align="center">△</td></tr><tr><td>Ransack Support</td><td align="center">O</td><td align="center">O</td><td align="center">O</td></tr></tbody></table><p>A comprehensive comparison shows that both ancestry and awesome_nested_set have their strengths. ancestry uses less storage space for data (but node moves are slower since all child nodes need to be loaded and updated). awesome_nested_set generally offers better query performance. However, during my testing, I encountered a bug with ancestry that caused data corruption. This happened when model records were loaded into memory and nodes were moved multiple times to different positions.</p><p>Additionally, awesome_nested_set works more seamlessly with Ransack, allowing direct queries using parent_id, which is more straightforward. Therefore, I think awesome_nested_set might be the better choice.</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://emn178.github.io/blog">小殘</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://emn178.github.io/blog/en/post/ancestry-vs-awesome-nested-set/">https://emn178.github.io/blog/en/post/ancestry-vs-awesome-nested-set/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/blog/images/logos/Ruby_On_Rails_Logo.svg" data-initialized="true"><a class="social-share-icon icon-facebook" href="#" aria-label="share to facebook"></a><a class="social-share-icon icon-twitter" href="#" aria-label="share to twitter"></a><a class="social-share-icon icon-wechat" href="#" aria-label="share to wechat"></a><a class="social-share-icon icon-weibo" href="#" aria-label="share to weibo"></a><a class="social-share-icon icon-qq" href="#" aria-label="share to qq"></a></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/blog/en/post/acts-as-taggable-on-vs-postgresql-array/" title="acts-as-taggable-on vs. PostgreSQL Array (acts-as-taggable-array-on)"><img class="cover" src="/blog/images/loading.svg" data-src="/blog/images/logos/Ruby_On_Rails_Logo.svg" onerror='onerror=null,src="/blog/img/404.jpg"' alt="cover of previous post"><noscript><img class="cover" src="/blog/images/logos/Ruby_On_Rails_Logo.svg" onerror='onerror=null,src="/blog/img/404.jpg"' alt="cover of previous post"></noscript><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">acts-as-taggable-on vs. PostgreSQL Array (acts-as-taggable-array-on)</div></div></a></div></nav><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/blog/images/loading.svg" data-src="/blog/images/avatar.jpg" onerror='this.onerror=null,this.src="/blog/img/friend_404.gif"' alt="avatar"><noscript><img src="/blog/images/avatar.jpg" onerror='this.onerror=null,this.src="/blog/img/friend_404.gif"' alt="avatar"></noscript></div><div class="author-info__name">emn178</div><div class="author-info__description">A blog sharing experiences about programming and technology.</div></div><div class="card-info-data site-data is-center"><a href="/blog/en/archives/"><div class="headline">Articles</div><div class="length-num">3</div></a><a href="/blog/en/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/blog/en/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Scenario"><span class="toc-number">1.</span> <span class="toc-text">Scenario</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Features"><span class="toc-number">2.</span> <span class="toc-text">Features</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ancestry"><span class="toc-number">2.1.</span> <span class="toc-text">ancestry</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Setup"><span class="toc-number">2.1.1.</span> <span class="toc-text">Setup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Basic-Usage"><span class="toc-number">2.1.2.</span> <span class="toc-text">Basic Usage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ransack-Search"><span class="toc-number">2.1.3.</span> <span class="toc-text">Ransack Search</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#awesome-nested-set"><span class="toc-number">2.2.</span> <span class="toc-text">awesome_nested_set</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Setup-1"><span class="toc-number">2.2.1.</span> <span class="toc-text">Setup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Basic-Usage-1"><span class="toc-number">2.2.2.</span> <span class="toc-text">Basic Usage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ransack-Search-1"><span class="toc-number">2.2.3.</span> <span class="toc-text">Ransack Search</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#closure-tree"><span class="toc-number">2.3.</span> <span class="toc-text">closure_tree</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Setup-2"><span class="toc-number">2.3.1.</span> <span class="toc-text">Setup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Basic-Usage-2"><span class="toc-number">2.3.2.</span> <span class="toc-text">Basic Usage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ransack-Search-2"><span class="toc-number">2.3.3.</span> <span class="toc-text">Ransack Search</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Benchmark"><span class="toc-number">3.</span> <span class="toc-text">Benchmark</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusions"><span class="toc-number">4.</span> <span class="toc-text">Conclusions</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/blog/en/post/ancestry-vs-awesome-nested-set/" title="ancestry vs. awesome_nested_set"><img src="/blog/images/loading.svg" data-src="/blog/images/logos/Ruby_On_Rails_Logo.svg" onerror='this.onerror=null,this.src="/blog/img/404.jpg"' alt="ancestry vs. awesome_nested_set"><noscript><img src="/blog/images/logos/Ruby_On_Rails_Logo.svg" onerror='this.onerror=null,this.src="/blog/img/404.jpg"' alt="ancestry vs. awesome_nested_set"></noscript></a><div class="content"><a class="title" href="/blog/en/post/ancestry-vs-awesome-nested-set/" title="ancestry vs. awesome_nested_set">ancestry vs. awesome_nested_set</a><time datetime="2025-05-17T13:16:57.000Z" title="Created 2025-05-17 21:16:57">2025-05-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/en/post/acts-as-taggable-on-vs-postgresql-array/" title="acts-as-taggable-on vs. PostgreSQL Array (acts-as-taggable-array-on)"><img src="/blog/images/loading.svg" data-src="/blog/images/logos/Ruby_On_Rails_Logo.svg" onerror='this.onerror=null,this.src="/blog/img/404.jpg"' alt="acts-as-taggable-on vs. PostgreSQL Array (acts-as-taggable-array-on)"><noscript><img src="/blog/images/logos/Ruby_On_Rails_Logo.svg" onerror='this.onerror=null,this.src="/blog/img/404.jpg"' alt="acts-as-taggable-on vs. PostgreSQL Array (acts-as-taggable-array-on)"></noscript></a><div class="content"><a class="title" href="/blog/en/post/acts-as-taggable-on-vs-postgresql-array/" title="acts-as-taggable-on vs. PostgreSQL Array (acts-as-taggable-array-on)">acts-as-taggable-on vs. PostgreSQL Array (acts-as-taggable-array-on)</a><time datetime="2025-04-14T13:32:09.000Z" title="Created 2025-04-14 21:32:09">2025-04-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/en/post/jbuilder-vs-active-model-serializers-vs-oj-serializers/" title="jbuilder vs active_model_serializers vs oj_serializers - Rails JSON API Comparison"><img src="/blog/images/loading.svg" data-src="/blog/images/logos/Ruby_On_Rails_Logo.svg" onerror='this.onerror=null,this.src="/blog/img/404.jpg"' alt="jbuilder vs active_model_serializers vs oj_serializers - Rails JSON API Comparison"><noscript><img src="/blog/images/logos/Ruby_On_Rails_Logo.svg" onerror='this.onerror=null,this.src="/blog/img/404.jpg"' alt="jbuilder vs active_model_serializers vs oj_serializers - Rails JSON API Comparison"></noscript></a><div class="content"><a class="title" href="/blog/en/post/jbuilder-vs-active-model-serializers-vs-oj-serializers/" title="jbuilder vs active_model_serializers vs oj_serializers - Rails JSON API Comparison">jbuilder vs active_model_serializers vs oj_serializers - Rails JSON API Comparison</a><time datetime="2025-03-23T02:03:34.000Z" title="Created 2025-03-23 10:03:34">2025-03-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2010 - 2025 By emn178</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/blog/js/utils.js?v=4"></script><script src="/blog/js/main.js?v=14"></script><div class="js-pjax"><script>function loadDisqus(){var e,t,s=function(){this.page.url="https://emn178.github.io/blog/en/post/ancestry-vs-awesome-nested-set/",this.page.identifier="/blog/en/post/ancestry-vs-awesome-nested-set/",this.page.title="ancestry vs. awesome_nested_set"};window.disqusReset=()=>{DISQUS.reset({reload:!0,config:s})},window.DISQUS?disqusReset():(e=document,(t=e.createElement("script")).src="https://emn178-blog.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)),document.getElementById("darkmode").addEventListener("click",()=>{setTimeout(()=>window.disqusReset(),200)})}{function loadOtherComment(){loadDisqus()}btf.loadComment(document.getElementById("disqus_thread"),loadDisqus)}</script></div></div></body></html>