<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="content-language" content="en"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Using Web3.js to Sign and Recover | emn178's Blog</title><meta name="keywords" content="Blockchain,Smart Contract,ecrecover,signature,vrs,Web3.js,web3.eth.sign,web3.eth.accounts.sign,web3.personal.sign,web3.eth.accounts.recover,web3.eth.personal.ecRecover"><meta name="author" content="emn178"><meta name="copyright" content="emn178"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Solidity - ecrecover this article explains how smart contracts verify signatures. This article will explain how to use Web3.js to sign and recover. Th"><meta property="og:type" content="article"><meta property="og:title" content="Using Web3.js to Sign and Recover"><meta property="og:url" content="https://blog.emn178.cc/en/post/using-web3-js-to-sign-and-recover/"><meta property="og:site_name" content="emn178&#39;s Blog"><meta property="og:description" content="Solidity - ecrecover this article explains how smart contracts verify signatures. This article will explain how to use Web3.js to sign and recover. Th"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blog.emn178.cc/images/zh-TW/post/2023/using-web3-js-to-parse-custom-error/web3js.jpg"><meta property="article:published_time" content="2023-10-10T01:03:27.000Z"><meta property="article:modified_time" content="2023-10-13T11:51:16.971Z"><meta property="article:author" content="emn178"><meta property="article:tag" content="AI,Coding,Programming,Technology"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.emn178.cc/images/zh-TW/post/2023/using-web3-js-to-parse-custom-error/web3js.jpg"><link rel="shortcut icon" href="/favicon.png"><link rel="canonical" href="https://blog.emn178.cc/en/post/using-web3-js-to-sign-and-recover/"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css?v=26"><link rel="preload" href="/libs/fontawesome-free-6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel=&quot;stylesheet&quot;"><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:void 0,translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"Copy successfully",error:"Copy error",noSupport:"The browser does not support"},relativeDate:{homepage:!1,post:!1},runtime:"",date_suffix:{just:"Just",min:"minutes ago",hour:"hours ago",day:"days ago",month:"months ago"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1,percent:{toc:!0,rightside:!1}},delayScripts=[],delayStyles=[],maybeMobile=window.innerWidth<=800;if(delayScripts.push({delay:maybeMobile?1e3:0,src:"/js/lazyload.iife.min.js",onload:()=>initLazyLoad()}),delayScripts.push({delay:maybeMobile?2e3:1e3,src:"/js/fancybox.umd.min.js",onload:()=>runLightbox()}),delayStyles.push({delay:maybeMobile?2e3:1e3,href:"/css/fancybox.min.css"}),delayScripts.push({delay:3e3,src:"/libs/share-js/js/social-share.min.js"}),delayStyles.push({delay:3e3,href:"/libs/share-js/css/share.min.css"}),"localhost:4000"!==location.host){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MPNMQM2EN1"),gtag({event:"gtm.js","gtm.start":(new Date).getTime(),"gtm.uniqueEventId":0})}function initGTMOnEvent(e){document.removeEventListener(event.type,initGTMOnEvent),initGTM()}function initGTM(){if(window.gtmDidInit)return;window.gtmDidInit=!0;const e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=/G-MPNMQM2EN1",document.head.appendChild(e)}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initGTM,3500)}),document.addEventListener("scroll",initGTMOnEvent),document.addEventListener("mousemove",initGTMOnEvent),document.addEventListener("touchstart",initGTMOnEvent),delayScripts.push({delay:0,src:"//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"})</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Using Web3.js to Sign and Recover",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-10-13 19:51:16"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)}),e.getCSS=(e,t=!1)=>new Promise((o,n)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=e,t&&(a.id=t),a.onerror=n,a.onload=a.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,o())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="alternate" href="/en/atom.xml" title="小殘的程式光廊" type="application/atom+xml">
<link rel="alternate" href="/en/rss2.xml" title="小殘的程式光廊" type="application/rss+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/loading.svg" data-src="/images/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"><noscript><img src="/images/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></noscript></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">214</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">15</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/en/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/en/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/en/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-rss"></i><span> Subscriptions</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/atom.xml"><i class="fa-fw fas fa-rss"></i><span> ATOM</span></a></li><li><a class="site-page child" href="/en/rss2.xml"><i class="fa-fw fas fa-rss"></i><span> RSS</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/zh-TW/"><i class="fa-fw fas fa-globe"></i><span> 中文</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/images/zh-TW/post/2023/using-web3-js-to-parse-custom-error/web3js.jpg)"><nav id="nav"><span id="blog-info"><a href="/en/" title="emn178's Blog"><span class="site-name">emn178's Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/en/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/en/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/en/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-rss"></i><span> Subscriptions</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/atom.xml"><i class="fa-fw fas fa-rss"></i><span> ATOM</span></a></li><li><a class="site-page child" href="/en/rss2.xml"><i class="fa-fw fas fa-rss"></i><span> RSS</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/zh-TW/"><i class="fa-fw fas fa-globe"></i><span> 中文</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Using Web3.js to Sign and Recover</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fas fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-10-10T01:03:27.000Z" title="Created 2023-10-10 09:03:27">2023-10-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-10-13T11:51:16.971Z" title="Updated 2023-10-13 19:51:16">2023-10-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/en/categories/Blockchain/">Blockchain</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="Using Web3.js to Sign and Recover"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><a href="/en/post/solidity-ecrecover/">Solidity - ecrecover</a> this article explains how smart contracts verify signatures. This article will explain how to use Web3.js to sign and recover. This article uses Web3.js version 4.1.1.</p><h2 id="Sign"><a href="#Sign" class="headerlink" title="Sign"></a>Sign</h2><p>Web3.js provides several off-chain signing functions. This article introduces the following three:</p><ol><li>web3.eth.sign</li><li>web3.eth.accounts.sign</li><li>web3.personal.sign</li></ol><p>For EIP-712 related methods, refer to <a href="../using-web3-js-to-sign-eip-712-typed-structured-data/">Using Web3.js to Sign and Recover EIP-712 Typed Structured Data</a>.</p><h3 id="web3-eth-sign"><a href="#web3-eth-sign" class="headerlink" title="web3.eth.sign"></a>web3.eth.sign</h3><p>This is an old function, and the signature does not use a prefix.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="title function_">sign</span>(<span class="attr">message</span>: <span class="title class_">Bytes</span>, <span class="attr">address</span>: string): <span class="title class_">Promise</span>&lt;string&gt;</span><br></pre></td></tr></table></figure><ul><li>message: The message to sign. It can only be binary content with a length of 32 bytes. It can be a Uint8Array or a string starting with 0x.</li><li>address: Address of the signer.</li><li>Return: A Promise object, and the content is a signature.</li></ul><p>Metamask has disabled this feature. If you use it, you will see an error message in the console:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inpage.js:1 MetaMask - RPC Error: eth_sign has been disabled. You must enable it in the advanced settings &#123;code: -32601, message: &#x27;eth_sign has been disabled. You must enable it in the advanced settings&#x27;&#125;</span><br></pre></td></tr></table></figure><p>If you want to use it, you need to enable the settings in Metamask:<br>[Settings] &#x3D;&gt; [Advanced] &#x3D;&gt; [Eth_sign requests]<br><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909195917.jpg" alt="Eth_sign requests" title="Eth_sign requests" width="317" height="193"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909195917.jpg" alt="Eth_sign requests" title="Eth_sign requests" width="317" height="193"></noscript></p><p>Turn on and enter <code>I only sign what I understand</code><br><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909195901.jpg" alt="I only sign what I understand" title="I only sign what I understand" width="307" height="515"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909195901.jpg" alt="I only sign what I understand" title="I only sign what I understand" width="307" height="515"></noscript></p><p>Try signing again, for example, run the following program:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> account = <span class="string">&#x27;0xDD980c315dFA75682F04381E98ea38BD2A151540&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0xe1077fb9321c187d8a43926896abac5455ce6add269e098f855ff059d6b846a356320be5f6d79c4d0e5583d6b9a2e50fae78f1fb5ff0553541e69c66dae2b2f81b</span></span><br><span class="line"><span class="keyword">const</span> signature = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">sign</span>(message, account);</span><br></pre></td></tr></table></figure><p>We can see that the signing content is a hash.<br><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909200353.jpg" alt="Sign" title="Sign" width="351" height="586"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909200353.jpg" alt="Sign" title="Sign" width="351" height="586"></noscript></p><p>Because this method is not recommended, a warning will appear every time you sign.<br><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909200414.jpg" alt="Warning" title="Warning" width="323" height="408"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909200414.jpg" alt="Warning" title="Warning" width="323" height="408"></noscript></p><p>We can use the library to split the signature.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromRpcSig &#125; <span class="keyword">from</span> <span class="string">&#x27;ethereumjs-util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   v: 27,</span></span><br><span class="line"><span class="comment">//   r: &lt;Buffer e1 07 7f b9 32 1c 18 7d 8a 43 92 68 96 ab ac 54 55 ce 6a dd 26 9e 09 8f 85 5f f0 59 d6 b8 46 a3&gt;,</span></span><br><span class="line"><span class="comment">//   s: &lt;Buffer 56 32 0b e5 f6 d7 9c 4d 0e 55 83 d6 b9 a2 e5 0f ae 78 f1 fb 5f f0 55 35 41 e6 9c 66 da e2 b2 f8&gt;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="title function_">fromRpcSig</span>(signature);</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   v: &#x27;0x1b&#x27;,</span></span><br><span class="line"><span class="comment">//   r: &#x27;0xe1077fb9321c187d8a43926896abac5455ce6add269e098f855ff059d6b846a3&#x27;,</span></span><br><span class="line"><span class="comment">//   s: &#x27;0x56320be5f6d79c4d0e5583d6b9a2e50fae78f1fb5ff0553541e69c66dae2b2f8&#x27;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">const</span> vrs = &#123;</span><br><span class="line">  <span class="attr">v</span>: <span class="string">`0x<span class="subst">$&#123;result.v.toString(<span class="number">16</span>)&#125;</span>`</span>,</span><br><span class="line">  <span class="attr">r</span>: <span class="string">`0x<span class="subst">$&#123;result.r.toString(<span class="string">&#x27;hex&#x27;</span>)&#125;</span>`</span>,</span><br><span class="line">  <span class="attr">s</span>: <span class="string">`0x<span class="subst">$&#123;result.s.toString(<span class="string">&#x27;hex&#x27;</span>)&#125;</span>`</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Corresponding to the smart contracts, it’s the first example without prefix.</p><figure class="highlight solidity"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bytes32</span> hash <span class="operator">=</span> <span class="number">0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53</span>;</span><br><span class="line"><span class="keyword">uint8</span> v <span class="operator">=</span> <span class="number">0x1b</span>;</span><br><span class="line"><span class="keyword">bytes32</span> r <span class="operator">=</span> <span class="number">0xe1077fb9321c187d8a43926896abac5455ce6add269e098f855ff059d6b846a3</span>;</span><br><span class="line"><span class="keyword">bytes32</span> s <span class="operator">=</span> <span class="number">0x56320be5f6d79c4d0e5583d6b9a2e50fae78f1fb5ff0553541e69c66dae2b2f8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0xDD980c315dFA75682F04381E98ea38BD2A151540</span></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">ecrecover</span>(hash , v, r, s);</span><br></pre></td></tr></table></figure><h3 id="web3-eth-accounts-sign"><a href="#web3-eth-accounts-sign" class="headerlink" title="web3.eth.accounts.sign"></a>web3.eth.accounts.sign</h3><p>Private key using this function to sign, and it will add the EIP-191 prefix.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">sign</span>(<span class="attr">data</span>: string, <span class="attr">privateKey</span>: <span class="title class_">Bytes</span>): <span class="title class_">SignResult</span></span><br></pre></td></tr></table></figure><ul><li>data: Content to sign. It can be text content or binary data(string starting with 0x).</li><li>privateKey: Signer’s private key. It can be a Uint8Array or a string starting with 0x.</li><li>Return: Signature object, please refer to the following example.</li></ul><p>With the prefix, the signing content is</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">“\x19Ethereum Signed Message:\n” + message.length + message</span><br></pre></td></tr></table></figure><p>For example, we sign the same content:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> privateKey = <span class="string">&#x27;0x....&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   message: &#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53&#x27;,</span></span><br><span class="line"><span class="comment">//   messageHash: &#x27;0x69a1658d9d5e169959e0e2acec0eb76ec15549ebc0680f45cfc25c4a3ca952e6&#x27;,</span></span><br><span class="line"><span class="comment">//   v: &#x27;0x1c&#x27;,</span></span><br><span class="line"><span class="comment">//   r: &#x27;0x3105c6f9bcc43236f5ef5e78038506c2551fc11d65701097295094c06c9d4f3&#x27;,</span></span><br><span class="line"><span class="comment">//   s: &#x27;0x29ec14347d37d8115cebcf915dc8f6f74c011698d9b7aea15c184f2277197a&#x27;,</span></span><br><span class="line"><span class="comment">//   signature: &#x27;0x03105c6f9bcc43236f5ef5e78038506c2551fc11d65701097295094c06c9d4f30029ec14347d37d8115cebcf915dc8f6f74c011698d9b7aea15c184f2277197a1c&#x27;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">const</span> signature = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">sign</span>(message, privateKey);</span><br></pre></td></tr></table></figure><p>You will find that the signature result is different from the above, and the format is also different. At the same time, we also found that there is a bug here. The returned r and s miss leading 0. The correct answer should be:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x03105c6f9bcc43236f5ef5e78038506c2551fc11d65701097295094c06c9d4f3</span><br><span class="line">0x0029ec14347d37d8115cebcf915dc8f6f74c011698d9b7aea15c184f2277197a</span><br></pre></td></tr></table></figure><p>There is this bug in v4.1.1, it is normal in older versions 1.x. We can use the signature property first. Using prefix in smart contracts to check:</p><figure class="highlight solidity"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bytes32</span> messageHash <span class="operator">=</span> <span class="number">0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53</span>;</span><br><span class="line"><span class="keyword">bytes32</span> hash <span class="operator">=</span> <span class="built_in">keccak256</span>(<span class="built_in">abi</span>.<span class="built_in">encodePacked</span>(<span class="string">&quot;\x19Ethereum Signed Message:\n32&quot;</span>, messageHash));</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">ecrecover</span>(hash , v, r, s);</span><br></pre></td></tr></table></figure><p>I have a <a target="_blank" rel="noopener" href="https://github.com/web3/web3.js/pull/6411">PR</a> to fix this bug. It should be no problem in 4.1.2 and above.</p><p>Or sign plain text content:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;OK!&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   message: &#x27;OK!&#x27;,</span></span><br><span class="line"><span class="comment">//   messageHash: &#x27;0x9632976ae3bb56254c6cc1a35ad3d11e7a7040fb6dde433ad2a1249afaf062f3&#x27;,</span></span><br><span class="line"><span class="comment">//   v: &#x27;0x1c&#x27;,</span></span><br><span class="line"><span class="comment">//   r: &#x27;0x7dff4feac0d0bf31d5b11ef3793bf9d00e7b9028eaaa9737f5079685ff435c9c&#x27;,</span></span><br><span class="line"><span class="comment">//   s: &#x27;0x7a22e79b7dab0b0d37524a0f9621d98b76fbc77b6402f87d142746eee61edcb2&#x27;,</span></span><br><span class="line"><span class="comment">//   signature: &#x27;0x7dff4feac0d0bf31d5b11ef3793bf9d00e7b9028eaaa9737f5079685ff435c9c7a22e79b7dab0b0d37524a0f9621d98b76fbc77b6402f87d142746eee61edcb21c&#x27;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">const</span> signature = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">sign</span>(message, privateKey);</span><br></pre></td></tr></table></figure><p>Solidity</p><figure class="highlight solidity"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="keyword">memory</span> message <span class="operator">=</span> <span class="string">&quot;OK!&quot;</span>;</span><br><span class="line"><span class="keyword">bytes32</span> hash <span class="operator">=</span> <span class="built_in">keccak256</span>(<span class="built_in">abi</span>.<span class="built_in">encodePacked</span>(<span class="string">&quot;\x19Ethereum Signed Message:\n3&quot;</span>, message));</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">ecrecover</span>(hash , v, r, s);</span><br></pre></td></tr></table></figure><p>Note that if the text is UTF-8, the length of the signature on the chain must be bytes. For example:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="string">&#x27;中文&#x27;</span>]).<span class="property">size</span></span><br></pre></td></tr></table></figure><h3 id="web3-eth-personal-sign"><a href="#web3-eth-personal-sign" class="headerlink" title="web3.eth.personal.sign"></a>web3.eth.personal.sign</h3><p>Browser wallets using this function to sign, and it will be prefixed with EIP-191.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">sign</span>(<span class="attr">data</span>: string, <span class="attr">address</span>: string, <span class="attr">passphrase</span>: string): <span class="title class_">Promise</span>&lt;string&gt;</span><br></pre></td></tr></table></figure><ul><li>data: Content to sign. It can be text content or binary data(string starting with 0x).</li><li>address: Address of the signer.</li><li>passphrase: Wallet password, not required.</li><li>Return: Signature object, please refer to the following example.</li></ul><p>The prefix rules are the same as <code>web3.eth.accounts.sign</code> and will not repeat.</p><p>For example, execute the following signature:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> account = <span class="string">&#x27;0xDD980c315dFA75682F04381E98ea38BD2A151540&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0x03105c6f9bcc43236f5ef5e78038506c2551fc11d65701097295094c06c9d4f30029ec14347d37d8115cebcf915dc8f6f74c011698d9b7aea15c184f2277197a1c</span></span><br><span class="line"><span class="keyword">const</span> signature = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">sign</span>(message, account, <span class="string">&#x27;&#x27;</span>);</span><br></pre></td></tr></table></figure><p>A message will pop up as follows:<br><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230910115133.jpg" alt="Sign" title="Sign" width="355" height="590"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230910115133.jpg" alt="Sign" title="Sign" width="355" height="590"></noscript></p><p>The result is the same as <code>web3.eth.accounts.sign</code>, but the format returned is different. Also try text:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;OK!&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0x7dff4feac0d0bf31d5b11ef3793bf9d00e7b9028eaaa9737f5079685ff435c9c7a22e79b7dab0b0d37524a0f9621d98b76fbc77b6402f87d142746eee61edcb21c</span></span><br><span class="line"><span class="keyword">const</span> signature = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">sign</span>(message, account, <span class="string">&#x27;&#x27;</span>);</span><br></pre></td></tr></table></figure><p>A message will pop up as follows:<br><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230910115253.jpg" alt="Sign Text" title="Sign Text" width="354" height="588"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230910115253.jpg" alt="Sign Text" title="Sign Text" width="354" height="588"></noscript></p><p>But if it is data starting with 0x, but the length is not 32 Bytes</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Truncate the last 1 Byte</span></span><br><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signature = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">sign</span>(message, account, <span class="string">&#x27;&#x27;</span>);</span><br></pre></td></tr></table></figure><p>The result will be a string of garbled characters<br><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230910115415.jpg" alt="Garbled Characters" title="Garbled Characters" width="357" height="589"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230910115415.jpg" alt="Garbled Characters" title="Garbled Characters" width="357" height="589"></noscript></p><p>The smart contracts is also the same as <code>web3.eth.accounts.sign</code> and will not repeat.</p><h2 id="Signature-Format"><a href="#Signature-Format" class="headerlink" title="Signature Format"></a>Signature Format</h2><p>The above signature has two formats: Splitted and not splitted. Wee can split it by fixed length. The first 32 bytes are r, the middle 32 bytes are s, and the last 1 byte is v. The example above:</p><p>signature: <span style="color:#00f">0xe1077fb9321c187d8a43926896abac5455ce6add269e098f855ff059d6b846a3</span><span style="color:green">56320be5f6d79c4d0e5583d6b9a2e50fae78f1fb5ff0553541e69c66dae2b2f8</span><span style="color:red">1b</span></p><p>r: <span style="color:#00f">0xe1077fb9321c187d8a43926896abac5455ce6add269e098f855ff059d6b846a3</span><br>s: <span style="color:green">0x56320be5f6d79c4d0e5583d6b9a2e50fae78f1fb5ff0553541e69c66dae2b2f8</span><br>v: <span style="color:red">0x1b</span></p><p>Therefore, in addition to using the library mentioned above to split the signature, we can also simply do it ourself:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">splitSignature</span>(<span class="params">signature</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">r</span>: <span class="string">`0x<span class="subst">$&#123;signature.substring(<span class="number">2</span>, <span class="number">66</span>)&#125;</span>`</span>,</span><br><span class="line">    <span class="attr">s</span>: <span class="string">`0x<span class="subst">$&#123;signature.substring(<span class="number">66</span>, <span class="number">130</span>)&#125;</span>`</span>,</span><br><span class="line">    <span class="attr">v</span>: <span class="string">`0x<span class="subst">$&#123;signature.substring(<span class="number">130</span>, <span class="number">132</span>)&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Recover-Signature"><a href="#Recover-Signature" class="headerlink" title="Recover Signature"></a>Recover Signature</h2><p>In addition to verify and recover in smart contracts, we can also use Web3.js. It can be used as back-end program for login. We can use the following function:</p><ol><li>web3.eth.accounts.recover</li><li>web3.eth.personal.ecRecover</li></ol><h3 id="web3-eth-accounts-recover"><a href="#web3-eth-accounts-recover" class="headerlink" title="web3.eth.accounts.recover"></a>web3.eth.accounts.recover</h3><p>This function supports multiple verification methods. You can enter a splitted or not splitted signature, with or without a prefix. There are multiple input methods:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(<span class="attr">data</span>: string, <span class="attr">v</span>: string, <span class="attr">r</span>: string, <span class="attr">s</span>: string, <span class="attr">prefixed</span>:? boolean): string</span><br></pre></td></tr></table></figure><ul><li>data: Content to sign. It can be text content or binary data(string starting with 0x).</li><li>v: v value of signature. A string starting with 0x.</li><li>r: r value of signature. A string starting with 0x.</li><li>s: s value of signature. A string starting with 0x.</li><li>prefixed: true means no prefix, false means use prefix. Default is false.</li><li>Return: Signer’s address.</li></ul><p>or an not splitted signature</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(<span class="attr">data</span>: A string, <span class="attr">signature</span>: string, <span class="attr">prefixed</span>:? boolean): string</span><br></pre></td></tr></table></figure><ul><li>data: Content to sign. It can be text content or binary data(string starting with 0x).</li><li>signature: Not splitted signature. A string starting with 0x.</li><li>prefixed: true means no prefix, false means use prefix. Default false</li><li>Return: Signer’s address.</li></ul><p>or object</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(<span class="attr">data</span>: <span class="title class_">SignatureObject</span>, <span class="attr">_</span>: string, <span class="attr">prefixed</span>:? boolean): string</span><br><span class="line"></span><br><span class="line"><span class="title class_">SignatureObject</span>: &#123;</span><br><span class="line">  <span class="attr">messageHash</span>: string;</span><br><span class="line">  <span class="attr">r</span>: string;</span><br><span class="line">  <span class="attr">s</span>: string;</span><br><span class="line">  <span class="attr">v</span>: string</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>data: Contains signing content and vrs.</li><li>_: Unused</li><li>prefixed: true means no prefix, false means use prefix. Default false</li><li>Return: Signer’s address.</li></ul><p>Corresponding to web3.eth.sign</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> v = <span class="string">&#x27;0x1b&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> r = <span class="string">&#x27;0xe1077fb9321c187d8a43926896abac5455ce6add269e098f855ff059d6b846a3&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> s = <span class="string">&#x27;0x56320be5f6d79c4d0e5583d6b9a2e50fae78f1fb5ff0553541e69c66dae2b2f8&#x27;</span>;</span><br><span class="line"><span class="comment">// 0xDD980c315dFA75682F04381E98ea38BD2A151540</span></span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(message, v, r, s, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> signature = <span class="string">&#x27;0xe1077fb9321c187d8a43926896abac5455ce6add269e098f855ff059d6b846a356320be5f6d79c4d0e5583d6b9a2e50fae78f1fb5ff0553541e69c66dae2b2f81b&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(message, signature, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> signatureObj = &#123;</span><br><span class="line">  v, r, s,</span><br><span class="line">  <span class="attr">messageHash</span>: message</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(signatureObj, <span class="string">&#x27;&#x27;</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>Corresponding to web3.eth.accounts.sign and web3.eth.personal.sign</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> v = <span class="string">&#x27;0x1c&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> r = <span class="string">&#x27;0x03105c6f9bcc43236f5ef5e78038506c2551fc11d65701097295094c06c9d4f3&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> s = <span class="string">&#x27;0x0029ec14347d37d8115cebcf915dc8f6f74c011698d9b7aea15c184f2277197a&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(message, v, r, s);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> signature = <span class="string">&#x27;0x03105c6f9bcc43236f5ef5e78038506c2551fc11d65701097295094c06c9d4f30029ec14347d37d8115cebcf915dc8f6f74c011698d9b7aea15c184f2277197a1c&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(message, signature);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> signatureObj = &#123;</span><br><span class="line">  v, r, s,</span><br><span class="line">  <span class="attr">messageHash</span>: message</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(signatureObj);</span><br></pre></td></tr></table></figure><p>Plain text content</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;OK!&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> v = <span class="string">&#x27;0x1c&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> r = <span class="string">&#x27;0x7dff4feac0d0bf31d5b11ef3793bf9d00e7b9028eaaa9737f5079685ff435c9c&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> s = <span class="string">&#x27;0x7a22e79b7dab0b0d37524a0f9621d98b76fbc77b6402f87d142746eee61edcb2&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(message, v, r, s);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> signature = <span class="string">&#x27;0x7dff4feac0d0bf31d5b11ef3793bf9d00e7b9028eaaa9737f5079685ff435c9c7a22e79b7dab0b0d37524a0f9621d98b76fbc77b6402f87d142746eee61edcb21c&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(message, signature);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> signatureObj = &#123;</span><br><span class="line">  v, r, s,</span><br><span class="line">  <span class="attr">messageHash</span>: message</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(signatureObj);</span><br></pre></td></tr></table></figure><h3 id="web3-eth-personal-ecRecover"><a href="#web3-eth-personal-ecRecover" class="headerlink" title="web3.eth.personal.ecRecover"></a>web3.eth.personal.ecRecover</h3><p>This function only supports not splitted signatures and always uses the EIP-191 prefix. Only browser wallet can be used.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">ecRecover</span>(<span class="attr">signedData</span>: string, <span class="attr">signature</span>: string): <span class="title class_">Promise</span>&lt;string&gt;</span><br></pre></td></tr></table></figure><ul><li>signedData: Content to sign. It can be text content or binary data(string starting with 0x).</li><li>signature: Not splitted signature. A string starting with 0x.</li><li>Return value: A Promise object, and the content is the signer’s address.</li></ul><p>Corresponding to web3.eth.accounts.sign and web3.eth.personal.sign</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signature = <span class="string">&#x27;0x03105c6f9bcc43236f5ef5e78038506c2551fc11d65701097295094c06c9d4f30029ec14347d37d8115cebcf915dc8f6f74c011698d9b7aea15c184f2277197a1c&#x27;</span>;</span><br><span class="line"><span class="comment">// 0xdd980c315dfa75682f04381e98ea38bd2a151540</span></span><br><span class="line"><span class="keyword">const</span> signer = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">ecRecover</span>(message, signature);</span><br></pre></td></tr></table></figure><p>Plain text content</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;OK!&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signature = <span class="string">&#x27;0x7dff4feac0d0bf31d5b11ef3793bf9d00e7b9028eaaa9737f5079685ff435c9c7a22e79b7dab0b0d37524a0f9621d98b76fbc77b6402f87d142746eee61edcb21c&#x27;</span>;</span><br><span class="line"><span class="comment">// 0xdd980c315dfa75682f04381e98ea38bd2a151540</span></span><br><span class="line"><span class="keyword">const</span> signer = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">ecRecover</span>(message, signature);</span><br></pre></td></tr></table></figure><h3 id="Signature-Malleability"><a href="#Signature-Malleability" class="headerlink" title="Signature Malleability"></a>Signature Malleability</h3><p>Web3.js also has the problem of <a href="../solidity-signature-malleability/">Signature Malleability</a>, and we can also check the value of s:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (s &gt; <span class="number">0x7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5D576E7357A4501DDFE92F46681B20A0n</span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;invalid s&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><ol><li><code>web3.eth.sign</code> is depracated and should not be used.</li><li>Private key wallet uses <code>web3.eth.accounts.sign</code> to sign.</li><li>Browser wallet uses <code>web3.personal.sign</code> to sign.</li><li>It is more general to use <code>web3.eth.accounts.recover</code> to recover and verify the signature.</li></ol><h2 id="Further-Reading"><a href="#Further-Reading" class="headerlink" title="Further Reading"></a>Further Reading</h2><p><a href="../solidity-ecrecover/">Solidity - ecrecover</a><br><a href="../solidity-signature-malleability/">Solidity - Signature Malleability</a><br><a href="../using-ethers-js-to-sign-and-recover/">Using Ethers.js to Sign and Recover</a><br><a href="../using-web3-js-to-sign-eip-712-typed-structured-data/">Using Web3.js to Sign and Recover EIP-712 Typed Structured Data</a></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://blog.emn178.cc">小殘</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.emn178.cc/en/post/using-web3-js-to-sign-and-recover/">https://blog.emn178.cc/en/post/using-web3-js-to-sign-and-recover/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/images/zh-TW/post/2023/using-web3-js-to-parse-custom-error/web3js.jpg" data-initialized="true"><a class="social-share-icon icon-facebook" href="#" aria-label="share to facebook"></a><a class="social-share-icon icon-twitter" href="#" aria-label="share to twitter"></a><a class="social-share-icon icon-wechat" href="#" aria-label="share to wechat"></a><a class="social-share-icon icon-weibo" href="#" aria-label="share to weibo"></a><a class="social-share-icon icon-qq" href="#" aria-label="share to qq"></a></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/en/post/solidity-signature-malleability/" title="Solidity - Signature Malleability"><img class="cover" src="/images/loading.svg" data-src="/images/zh-TW/post/2018/solidity-gas-optimization-variable-ordering/solidity-logo.svg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><noscript><img class="cover" src="/images/zh-TW/post/2018/solidity-gas-optimization-variable-ordering/solidity-logo.svg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"></noscript><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Solidity - Signature Malleability</div></div></a></div><div class="next-post pull-right"><a href="/en/post/using-ethers-js-to-sign-and-recover/" title="Using Ethers.js to Sign and Recover"><img class="cover" src="/images/loading.svg" data-src="/images/zh-TW/post/2023/ethers-js-parse-custom-error/ethers.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><noscript><img class="cover" src="/images/zh-TW/post/2023/ethers-js-parse-custom-error/ethers.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"></noscript><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Using Ethers.js to Sign and Recover</div></div></a></div></nav><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 評論</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/loading.svg" data-src="/images/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><noscript><img src="/images/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></noscript></div><div class="author-info__name">emn178</div><div class="author-info__description">A blog sharing experiences about programming and technology.</div></div><div class="card-info-data site-data is-center"><a href="/en/archives/"><div class="headline">Articles</div><div class="length-num">29</div></a><a href="/en/tags/"><div class="headline">Tags</div><div class="length-num">5</div></a><a href="/en/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Sign"><span class="toc-number">1.</span> <span class="toc-text">Sign</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#web3-eth-sign"><span class="toc-number">1.1.</span> <span class="toc-text">web3.eth.sign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web3-eth-accounts-sign"><span class="toc-number">1.2.</span> <span class="toc-text">web3.eth.accounts.sign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web3-eth-personal-sign"><span class="toc-number">1.3.</span> <span class="toc-text">web3.eth.personal.sign</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Signature-Format"><span class="toc-number">2.</span> <span class="toc-text">Signature Format</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Recover-Signature"><span class="toc-number">3.</span> <span class="toc-text">Recover Signature</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#web3-eth-accounts-recover"><span class="toc-number">3.1.</span> <span class="toc-text">web3.eth.accounts.recover</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web3-eth-personal-ecRecover"><span class="toc-number">3.2.</span> <span class="toc-text">web3.eth.personal.ecRecover</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Signature-Malleability"><span class="toc-number">3.3.</span> <span class="toc-text">Signature Malleability</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">4.</span> <span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Further-Reading"><span class="toc-number">5.</span> <span class="toc-text">Further Reading</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/en/post/using-ethers-js-to-sign-eip-712-typed-structured-data/" title="Using Ethers.js to Sign and Recover EIP-712 Typed Structured Data"><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/ethers-js-parse-custom-error/ethers.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Using Ethers.js to Sign and Recover EIP-712 Typed Structured Data"><noscript><img src="/images/zh-TW/post/2023/ethers-js-parse-custom-error/ethers.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Using Ethers.js to Sign and Recover EIP-712 Typed Structured Data"></noscript></a><div class="content"><a class="title" href="/en/post/using-ethers-js-to-sign-eip-712-typed-structured-data/" title="Using Ethers.js to Sign and Recover EIP-712 Typed Structured Data">Using Ethers.js to Sign and Recover EIP-712 Typed Structured Data</a><time datetime="2023-10-14T02:17:23.000Z" title="Created 2023-10-14 10:17:23">2023-10-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/post/using-web3-js-to-sign-and-recover-eip-712-typed-structured-data/" title="Using Web3.js to Sign and Recover EIP-712 Typed Structured Data"><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-parse-custom-error/web3js.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Using Web3.js to Sign and Recover EIP-712 Typed Structured Data"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-parse-custom-error/web3js.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Using Web3.js to Sign and Recover EIP-712 Typed Structured Data"></noscript></a><div class="content"><a class="title" href="/en/post/using-web3-js-to-sign-and-recover-eip-712-typed-structured-data/" title="Using Web3.js to Sign and Recover EIP-712 Typed Structured Data">Using Web3.js to Sign and Recover EIP-712 Typed Structured Data</a><time datetime="2023-10-13T11:50:47.000Z" title="Created 2023-10-13 19:50:47">2023-10-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/post/solidity-eip-712-typed-structured-data-hashing-and-signing/" title="Solidity - EIP-712 Typed Structured Data Hashing and Signing"><img src="/images/loading.svg" data-src="/images/zh-TW/post/2018/solidity-gas-optimization-variable-ordering/solidity-logo.svg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Solidity - EIP-712 Typed Structured Data Hashing and Signing"><noscript><img src="/images/zh-TW/post/2018/solidity-gas-optimization-variable-ordering/solidity-logo.svg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Solidity - EIP-712 Typed Structured Data Hashing and Signing"></noscript></a><div class="content"><a class="title" href="/en/post/solidity-eip-712-typed-structured-data-hashing-and-signing/" title="Solidity - EIP-712 Typed Structured Data Hashing and Signing">Solidity - EIP-712 Typed Structured Data Hashing and Signing</a><time datetime="2023-10-12T12:39:22.000Z" title="Created 2023-10-12 20:39:22">2023-10-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/post/using-ethers-js-to-sign-and-recover/" title="Using Ethers.js to Sign and Recover"><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/ethers-js-parse-custom-error/ethers.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Using Ethers.js to Sign and Recover"><noscript><img src="/images/zh-TW/post/2023/ethers-js-parse-custom-error/ethers.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Using Ethers.js to Sign and Recover"></noscript></a><div class="content"><a class="title" href="/en/post/using-ethers-js-to-sign-and-recover/" title="Using Ethers.js to Sign and Recover">Using Ethers.js to Sign and Recover</a><time datetime="2023-10-11T11:59:57.000Z" title="Created 2023-10-11 19:59:57">2023-10-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/post/using-web3-js-to-sign-and-recover/" title="Using Web3.js to Sign and Recover"><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-parse-custom-error/web3js.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Using Web3.js to Sign and Recover"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-parse-custom-error/web3js.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Using Web3.js to Sign and Recover"></noscript></a><div class="content"><a class="title" href="/en/post/using-web3-js-to-sign-and-recover/" title="Using Web3.js to Sign and Recover">Using Web3.js to Sign and Recover</a><time datetime="2023-10-10T01:03:27.000Z" title="Created 2023-10-10 09:03:27">2023-10-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2010 - 2023 By emn178</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4"></script><script src="/js/main.js?v=14"></script><div class="js-pjax"><script>function loadDisqus(){var e,t,s=function(){this.page.url="https://blog.emn178.cc/en/post/using-web3-js-to-sign-and-recover/",this.page.identifier="/en/post/using-web3-js-to-sign-and-recover/",this.page.title="Using Web3.js to Sign and Recover"};window.disqusReset=()=>{DISQUS.reset({reload:!0,config:s})},window.DISQUS?disqusReset():(e=document,(t=e.createElement("script")).src="https://emn178.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)),document.getElementById("darkmode").addEventListener("click",()=>{setTimeout(()=>window.disqusReset(),200)})}{function loadOtherComment(){loadDisqus()}btf.loadComment(document.getElementById("disqus_thread"),loadDisqus)}</script></div></div></body></html>