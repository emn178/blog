<!DOCTYPE html><html lang="zh-TW" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="content-language" content="zh-TW"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>使用 Web3.js 簽章與檢驗 | 小殘的程式光廊</title><meta name="keywords" content="區塊鏈,智能合約,Smart Contract,ecrecover,signature,vrs,Web3.js,web3.eth.sign,web3.eth.accounts.sign,web3.personal.sign,web3.eth.accounts.recover,web3.eth.personal.ecRecover"><meta name="author" content="小殘"><meta name="copyright" content="小殘"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="之前在 Solidity 智能合約 - ecrecover 簽章檢驗這篇文章，說明了智能合約如何檢驗簽章，這篇文章將說明如何使用 Web3.js 來進行簽章與檢驗。本篇文章使用 Web3.js 4.1.1 版本。 簽章Web3.js 提供幾種鏈下簽章的函式，本篇文章介紹下面三種：  web3.eth"><meta property="og:type" content="article"><meta property="og:title" content="使用 Web3.js 簽章與檢驗"><meta property="og:url" content="https://blog.emn178.cc/zh-TW/post/using-web3-js-to-sign-and-recover/"><meta property="og:site_name" content="小殘的程式光廊"><meta property="og:description" content="之前在 Solidity 智能合約 - ecrecover 簽章檢驗這篇文章，說明了智能合約如何檢驗簽章，這篇文章將說明如何使用 Web3.js 來進行簽章與檢驗。本篇文章使用 Web3.js 4.1.1 版本。 簽章Web3.js 提供幾種鏈下簽章的函式，本篇文章介紹下面三種：  web3.eth"><meta property="og:locale" content="zh_TW"><meta property="og:image" content="https://blog.emn178.cc/images/zh-TW/post/2023/using-web3-js-to-parse-custom-error/web3js.jpg"><meta property="article:published_time" content="2023-09-10T06:41:44.000Z"><meta property="article:modified_time" content="2023-10-08T08:56:35.436Z"><meta property="article:author" content="小殘"><meta property="article:tag" content="AI,程式技術,旅遊"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.emn178.cc/images/zh-TW/post/2023/using-web3-js-to-parse-custom-error/web3js.jpg"><link rel="shortcut icon" href="/favicon.png"><link rel="canonical" href="https://blog.emn178.cc/zh-TW/post/using-web3-js-to-sign-and-recover/"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css?v=23"><link rel="preload" href="/libs/fontawesome-free-6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel=&quot;stylesheet&quot;"><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:void 0,translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"複製成功",error:"複製錯誤",noSupport:"瀏覽器不支援"},relativeDate:{homepage:!1,post:!1},runtime:"",date_suffix:{just:"剛剛",min:"分鐘前",hour:"小時前",day:"天前",month:"個月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1,percent:{toc:!0,rightside:!1}},delayScripts=[],delayStyles=[],maybeMobile=window.innerWidth<=800;if(delayScripts.push({delay:maybeMobile?1e3:0,src:"/js/lazyload.iife.min.js",onload:()=>initLazyLoad()}),delayScripts.push({delay:maybeMobile?2e3:1e3,src:"/js/fancybox.umd.min.js",onload:()=>runLightbox()}),delayStyles.push({delay:maybeMobile?2e3:1e3,href:"/css/fancybox.min.css"}),delayScripts.push({delay:3e3,src:"/libs/share-js/js/social-share.min.js"}),delayStyles.push({delay:3e3,href:"/libs/share-js/css/share.min.css"}),"localhost:4000"!==location.host){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MPNMQM2EN1"),gtag({event:"gtm.js","gtm.start":(new Date).getTime(),"gtm.uniqueEventId":0})}function initGTMOnEvent(e){document.removeEventListener(event.type,initGTMOnEvent),initGTM()}function initGTM(){if(window.gtmDidInit)return;window.gtmDidInit=!0;const e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=/G-MPNMQM2EN1",document.head.appendChild(e)}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initGTM,3500)}),document.addEventListener("scroll",initGTMOnEvent),document.addEventListener("mousemove",initGTMOnEvent),document.addEventListener("touchstart",initGTMOnEvent),delayScripts.push({delay:0,src:"//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",onload:()=>initLazyLoad()})</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"使用 Web3.js 簽章與檢驗",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-10-08 16:56:35"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)}),e.getCSS=(e,t=!1)=>new Promise((o,n)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=e,t&&(a.id=t),a.onerror=n,a.onload=a.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,o())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="alternate" href="/zh-TW/atom.xml" title="小殘的程式光廊" type="application/atom+xml">
<link rel="alternate" href="/zh-TW/rss2.xml" title="小殘的程式光廊" type="application/rss+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/loading.svg" data-src="/images/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"><noscript><img src="/images/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></noscript></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">155</div></a><a href="/tags/"><div class="headline">標籤</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分類</div><div class="length-num">14</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/zh-TW/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/zh-TW/archives/"><i class="fa-fw fas fa-archive"></i><span> 封存</span></a></div><div class="menus_item"><a class="site-page" href="/zh-TW/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/zh-TW/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-rss"></i><span> 訂閱</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/zh-TW/atom.xml"><i class="fa-fw fas fa-rss"></i><span> ATOM</span></a></li><li><a class="site-page child" href="/zh-TW/rss2.xml"><i class="fa-fw fas fa-rss"></i><span> RSS</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-globe"></i><span> English</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/images/zh-TW/post/2023/using-web3-js-to-parse-custom-error/web3js.jpg)"><nav id="nav"><span id="blog-info"><a href="/zh-TW/" title="小殘的程式光廊"><span class="site-name">小殘的程式光廊</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/zh-TW/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/zh-TW/archives/"><i class="fa-fw fas fa-archive"></i><span> 封存</span></a></div><div class="menus_item"><a class="site-page" href="/zh-TW/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/zh-TW/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-rss"></i><span> 訂閱</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/zh-TW/atom.xml"><i class="fa-fw fas fa-rss"></i><span> ATOM</span></a></li><li><a class="site-page child" href="/zh-TW/rss2.xml"><i class="fa-fw fas fa-rss"></i><span> RSS</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-globe"></i><span> English</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">使用 Web3.js 簽章與檢驗</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fas fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">發表於</span><time class="post-meta-date-created" datetime="2023-09-10T06:41:44.000Z" title="發表於 2023-09-10 14:41:44">2023-09-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新於</span><time class="post-meta-date-updated" datetime="2023-10-08T08:56:35.436Z" title="更新於 2023-10-08 16:56:35">2023-10-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/zh-TW/categories/%E5%8D%80%E5%A1%8A%E9%8F%88/">區塊鏈</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="使用 Web3.js 簽章與檢驗"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">閱讀量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>之前在 <a href="/zh-TW/post/solidity-ecrecover/">Solidity 智能合約 - ecrecover 簽章檢驗</a>這篇文章，說明了智能合約如何檢驗簽章，這篇文章將說明如何使用 Web3.js 來進行簽章與檢驗。本篇文章使用 Web3.js 4.1.1 版本。</p><h2 id="簽章"><a href="#簽章" class="headerlink" title="簽章"></a>簽章</h2><p>Web3.js 提供幾種鏈下簽章的函式，本篇文章介紹下面三種：</p><ol><li>web3.eth.sign</li><li>web3.eth.accounts.sign</li><li>web3.personal.sign</li></ol><p>關於 EIP-712 相關的方法，參考<a href="../using-web3-js-to-sign-eip-712-typed-structured-data/">使用 Web3.js 進行 EIP-712 類型結構化資料簽名</a>。</p><h3 id="web3-eth-sign"><a href="#web3-eth-sign" class="headerlink" title="web3.eth.sign"></a>web3.eth.sign</h3><p>這是早期使用的函式，簽章不使用前綴。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="title function_">sign</span>(<span class="attr">message</span>: <span class="title class_">Bytes</span>, <span class="attr">address</span>: string): <span class="title class_">Promise</span>&lt;string&gt;</span><br></pre></td></tr></table></figure><ul><li>message: 簽署的內容，只能是 32 bytes 長度的二進位內容。可以是 Uint8Array 或 0x 開頭的字串。</li><li>address: 簽署人地址。</li><li>回傳值: 為 Promise 物件，內容為簽章。</li></ul><p>Metamask 已經停用了這個功能，使用會在 console 看到錯誤訊息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inpage.js:1 MetaMask - RPC Error: eth_sign has been disabled. You must enable it in the advanced settings &#123;code: -32601, message: &#x27;eth_sign has been disabled. You must enable it in the advanced settings&#x27;&#125;</span><br></pre></td></tr></table></figure><p>如果要使用要在 Metamask 中開啟設定：<br>[設定] &#x3D;&gt; [進階] &#x3D;&gt; [Eth_sign requests]<br><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909195917.jpg" alt="Eth_sign requests" title="Eth_sign requests" width="317" height="193"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909195917.jpg" alt="Eth_sign requests" title="Eth_sign requests" width="317" height="193"></noscript></p><p>開啟輸入 <code>I only sign what I understand</code><br><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909195901.jpg" alt="I only sign what I understand" title="I only sign what I understand" width="307" height="515"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909195901.jpg" alt="I only sign what I understand" title="I only sign what I understand" width="307" height="515"></noscript></p><p>再次嘗試簽章，例如執行以下程式：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> account = <span class="string">&#x27;0xDD980c315dFA75682F04381E98ea38BD2A151540&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0xe1077fb9321c187d8a43926896abac5455ce6add269e098f855ff059d6b846a356320be5f6d79c4d0e5583d6b9a2e50fae78f1fb5ff0553541e69c66dae2b2f81b</span></span><br><span class="line"><span class="keyword">const</span> signature = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">sign</span>(message, account);</span><br></pre></td></tr></table></figure><p>簽署過程可以看到簽署的內容為一串雜湊<br><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909200353.jpg" alt="簽署" title="簽署" width="351" height="586"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909200353.jpg" alt="簽署" title="簽署" width="351" height="586"></noscript></p><p>因為這個方法不建議使用所以每次簽署都會跳警告<br><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909200414.jpg" alt="簽署警告" title="簽署警告" width="323" height="408"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230909200414.jpg" alt="簽署警告" title="簽署警告" width="323" height="408"></noscript></p><p>可以利用套件切開簽章</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromRpcSig &#125; <span class="keyword">from</span> <span class="string">&#x27;ethereumjs-util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   v: 27,</span></span><br><span class="line"><span class="comment">//   r: &lt;Buffer e1 07 7f b9 32 1c 18 7d 8a 43 92 68 96 ab ac 54 55 ce 6a dd 26 9e 09 8f 85 5f f0 59 d6 b8 46 a3&gt;,</span></span><br><span class="line"><span class="comment">//   s: &lt;Buffer 56 32 0b e5 f6 d7 9c 4d 0e 55 83 d6 b9 a2 e5 0f ae 78 f1 fb 5f f0 55 35 41 e6 9c 66 da e2 b2 f8&gt;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="title function_">fromRpcSig</span>(signature);</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   v: &#x27;0x1b&#x27;,</span></span><br><span class="line"><span class="comment">//   r: &#x27;0xe1077fb9321c187d8a43926896abac5455ce6add269e098f855ff059d6b846a3&#x27;,</span></span><br><span class="line"><span class="comment">//   s: &#x27;0x56320be5f6d79c4d0e5583d6b9a2e50fae78f1fb5ff0553541e69c66dae2b2f8&#x27;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">const</span> vrs = &#123;</span><br><span class="line">  <span class="attr">v</span>: <span class="string">`0x<span class="subst">$&#123;result.v.toString(<span class="number">16</span>)&#125;</span>`</span>,</span><br><span class="line">  <span class="attr">r</span>: <span class="string">`0x<span class="subst">$&#123;result.r.toString(<span class="string">&#x27;hex&#x27;</span>)&#125;</span>`</span>,</span><br><span class="line">  <span class="attr">s</span>: <span class="string">`0x<span class="subst">$&#123;result.s.toString(<span class="string">&#x27;hex&#x27;</span>)&#125;</span>`</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>對應到智能合約的驗證，使用的是第一個範例無前綴的方式</p><figure class="highlight solidity"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bytes32</span> hash <span class="operator">=</span> <span class="number">0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53</span>;</span><br><span class="line"><span class="keyword">uint8</span> v <span class="operator">=</span> <span class="number">0x1b</span>;</span><br><span class="line"><span class="keyword">bytes32</span> r <span class="operator">=</span> <span class="number">0xe1077fb9321c187d8a43926896abac5455ce6add269e098f855ff059d6b846a3</span>;</span><br><span class="line"><span class="keyword">bytes32</span> s <span class="operator">=</span> <span class="number">0x56320be5f6d79c4d0e5583d6b9a2e50fae78f1fb5ff0553541e69c66dae2b2f8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0xDD980c315dFA75682F04381E98ea38BD2A151540</span></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">ecrecover</span>(hash , v, r, s);</span><br></pre></td></tr></table></figure><h3 id="web3-eth-accounts-sign"><a href="#web3-eth-accounts-sign" class="headerlink" title="web3.eth.accounts.sign"></a>web3.eth.accounts.sign</h3><p>私鑰簽署使用這函式，會加上 EIP-191 前綴。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">sign</span>(<span class="attr">data</span>: string, <span class="attr">privateKey</span>: <span class="title class_">Bytes</span>): <span class="title class_">SignResult</span></span><br></pre></td></tr></table></figure><ul><li>data: 簽署的內容，0x 開頭為 bytes 二進位資料，或是文字內容。</li><li>privateKey: 簽署人私鑰。可以是 Uint8Array 或 0x 開頭的字串。</li><li>回傳值: 簽章物件，內容參考下面例子。</li></ul><p>加上前綴，簽署內容為</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">“\x19Ethereum Signed Message:\n” + message.length + message</span><br></pre></td></tr></table></figure><p>例如我們簽署一樣內容</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> privateKey = <span class="string">&#x27;0x....&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   message: &#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53&#x27;,</span></span><br><span class="line"><span class="comment">//   messageHash: &#x27;0x69a1658d9d5e169959e0e2acec0eb76ec15549ebc0680f45cfc25c4a3ca952e6&#x27;,</span></span><br><span class="line"><span class="comment">//   v: &#x27;0x1c&#x27;,</span></span><br><span class="line"><span class="comment">//   r: &#x27;0x3105c6f9bcc43236f5ef5e78038506c2551fc11d65701097295094c06c9d4f3&#x27;,</span></span><br><span class="line"><span class="comment">//   s: &#x27;0x29ec14347d37d8115cebcf915dc8f6f74c011698d9b7aea15c184f2277197a&#x27;,</span></span><br><span class="line"><span class="comment">//   signature: &#x27;0x03105c6f9bcc43236f5ef5e78038506c2551fc11d65701097295094c06c9d4f30029ec14347d37d8115cebcf915dc8f6f74c011698d9b7aea15c184f2277197a1c&#x27;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">const</span> signature = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">sign</span>(message, privateKey);</span><br></pre></td></tr></table></figure><p>會發現簽章結果和上面不同，另外回傳的格式也不同。同時我們還發現這邊有個 bug，回傳的 r 和 s 前面沒有補 0，正確應該是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x03105c6f9bcc43236f5ef5e78038506c2551fc11d65701097295094c06c9d4f3</span><br><span class="line">0x0029ec14347d37d8115cebcf915dc8f6f74c011698d9b7aea15c184f2277197a</span><br></pre></td></tr></table></figure><p>在 v4.1.1 有這個 bug，舊版的 1.x 是正常的。我們可以先拿 signature 欄位來使用。對應在智能合約使用前綴的方式來檢驗：</p><figure class="highlight solidity"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bytes32</span> messageHash <span class="operator">=</span> <span class="number">0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53</span>;</span><br><span class="line"><span class="keyword">bytes32</span> hash <span class="operator">=</span> <span class="built_in">keccak256</span>(<span class="built_in">abi</span>.<span class="built_in">encodePacked</span>(<span class="string">&quot;\x19Ethereum Signed Message:\n32&quot;</span>, messageHash));</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">ecrecover</span>(hash , v, r, s);</span><br></pre></td></tr></table></figure><p>我有發 <a target="_blank" rel="noopener" href="https://github.com/web3/web3.js/pull/6411">PR</a> 修正個這 Bug，4.1.2 以上應該沒問題了。</p><p>或是簽署純文字內容</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;OK!&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   message: &#x27;OK!&#x27;,</span></span><br><span class="line"><span class="comment">//   messageHash: &#x27;0x9632976ae3bb56254c6cc1a35ad3d11e7a7040fb6dde433ad2a1249afaf062f3&#x27;,</span></span><br><span class="line"><span class="comment">//   v: &#x27;0x1c&#x27;,</span></span><br><span class="line"><span class="comment">//   r: &#x27;0x7dff4feac0d0bf31d5b11ef3793bf9d00e7b9028eaaa9737f5079685ff435c9c&#x27;,</span></span><br><span class="line"><span class="comment">//   s: &#x27;0x7a22e79b7dab0b0d37524a0f9621d98b76fbc77b6402f87d142746eee61edcb2&#x27;,</span></span><br><span class="line"><span class="comment">//   signature: &#x27;0x7dff4feac0d0bf31d5b11ef3793bf9d00e7b9028eaaa9737f5079685ff435c9c7a22e79b7dab0b0d37524a0f9621d98b76fbc77b6402f87d142746eee61edcb21c&#x27;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">const</span> signature = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">sign</span>(message, privateKey);</span><br></pre></td></tr></table></figure><p>智能合約</p><figure class="highlight solidity"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="keyword">memory</span> message <span class="operator">=</span> <span class="string">&quot;OK!&quot;</span>;</span><br><span class="line"><span class="keyword">bytes32</span> hash <span class="operator">=</span> <span class="built_in">keccak256</span>(<span class="built_in">abi</span>.<span class="built_in">encodePacked</span>(<span class="string">&quot;\x19Ethereum Signed Message:\n3&quot;</span>, message));</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">ecrecover</span>(hash , v, r, s);</span><br></pre></td></tr></table></figure><p>注意文字如果有 UTF-8 的話，在鏈上的簽署的長度要是 bytes 長度。例如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="string">&#x27;中文&#x27;</span>]).<span class="property">size</span></span><br></pre></td></tr></table></figure><h3 id="web3-eth-personal-sign"><a href="#web3-eth-personal-sign" class="headerlink" title="web3.eth.personal.sign"></a>web3.eth.personal.sign</h3><p>瀏覽器錢包簽署使用這函式，會加上 EIP-191 前綴。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">sign</span>(<span class="attr">data</span>: string, <span class="attr">address</span>: string, <span class="attr">passphrase</span>: string): <span class="title class_">Promise</span>&lt;string&gt;</span><br></pre></td></tr></table></figure><ul><li>data: 簽署的內容，0x 開頭為 bytes 二進位資料，或是文字內容。</li><li>address: 簽署人地址。</li><li>passphrase: 錢包密碼，可以不用填。</li><li>回傳值: 為 Promise 物件，內容為簽章。</li></ul><p>前綴規則同 <code>web3.eth.accounts.sign</code>，不重複說明。</p><p>例如執行以下簽章：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> account = <span class="string">&#x27;0xDD980c315dFA75682F04381E98ea38BD2A151540&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0x03105c6f9bcc43236f5ef5e78038506c2551fc11d65701097295094c06c9d4f30029ec14347d37d8115cebcf915dc8f6f74c011698d9b7aea15c184f2277197a1c</span></span><br><span class="line"><span class="keyword">const</span> signature = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">sign</span>(message, account, <span class="string">&#x27;&#x27;</span>);</span><br></pre></td></tr></table></figure><p>會跳出簽章訊息如下<br><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230910115133.jpg" alt="簽署" title="簽署" width="355" height="590"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230910115133.jpg" alt="簽署" title="簽署" width="355" height="590"></noscript></p><p>簽署結果和 <code>web3.eth.accounts.sign</code> 一樣，只是回傳的格式不同。同樣嘗試文字</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;OK!&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0x7dff4feac0d0bf31d5b11ef3793bf9d00e7b9028eaaa9737f5079685ff435c9c7a22e79b7dab0b0d37524a0f9621d98b76fbc77b6402f87d142746eee61edcb21c</span></span><br><span class="line"><span class="keyword">const</span> signature = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">sign</span>(message, account, <span class="string">&#x27;&#x27;</span>);</span><br></pre></td></tr></table></figure><p>會跳出簽章訊息如下<br><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230910115253.jpg" alt="簽署純文字" title="簽署純文字" width="354" height="588"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230910115253.jpg" alt="簽署純文字" title="簽署純文字" width="354" height="588"></noscript></p><p>但如果是 0x 開頭的資料，不過長度不是 32 Bytes</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 截掉最後 1 Byte</span></span><br><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signature = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">sign</span>(message, account, <span class="string">&#x27;&#x27;</span>);</span><br></pre></td></tr></table></figure><p>結果會變成一串亂碼<br><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230910115415.jpg" alt="簽署亂碼" title="簽署亂碼" width="357" height="589"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-sign-and-recover/20230910115415.jpg" alt="簽署亂碼" title="簽署亂碼" width="357" height="589"></noscript></p><p>智能合約的檢驗也和 <code>web3.eth.accounts.sign</code> 一樣，不重複說明。</p><h2 id="簽章格式"><a href="#簽章格式" class="headerlink" title="簽章格式"></a>簽章格式</h2><p>上面簽章有切開和未切開的兩種格式，切開就是照固定長度切開，前面 32 bytes 為 r，中間 32 bytes 為 s，最後 1 byte 為 v。拿上面的例子來看：</p><p>signature: <span style="color:#00f">0xe1077fb9321c187d8a43926896abac5455ce6add269e098f855ff059d6b846a3</span><span style="color:green">56320be5f6d79c4d0e5583d6b9a2e50fae78f1fb5ff0553541e69c66dae2b2f8</span><span style="color:red">1b</span></p><p>r: <span style="color:#00f">0xe1077fb9321c187d8a43926896abac5455ce6add269e098f855ff059d6b846a3</span><br>s: <span style="color:green">0x56320be5f6d79c4d0e5583d6b9a2e50fae78f1fb5ff0553541e69c66dae2b2f8</span><br>v: <span style="color:red">0x1b</span></p><p>所以要切開簽章除了使用上面提的套件之外，也可以自己簡單的處理：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">splitSignature</span>(<span class="params">signature</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">r</span>: <span class="string">`0x<span class="subst">$&#123;signature.substring(<span class="number">2</span>, <span class="number">66</span>)&#125;</span>`</span>,</span><br><span class="line">    <span class="attr">s</span>: <span class="string">`0x<span class="subst">$&#123;signature.substring(<span class="number">66</span>, <span class="number">130</span>)&#125;</span>`</span>,</span><br><span class="line">    <span class="attr">v</span>: <span class="string">`0x<span class="subst">$&#123;signature.substring(<span class="number">130</span>, <span class="number">132</span>)&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="檢驗簽章"><a href="#檢驗簽章" class="headerlink" title="檢驗簽章"></a>檢驗簽章</h2><p>除了在智能合約上的檢驗之外，我們也可以使用 Web3.js 來檢驗，可以作為後端程式登入之類的用途。可以用下面的函式：</p><ol><li>web3.eth.accounts.recover</li><li>web3.eth.personal.ecRecover</li></ol><h3 id="web3-eth-accounts-recover"><a href="#web3-eth-accounts-recover" class="headerlink" title="web3.eth.accounts.recover"></a>web3.eth.accounts.recover</h3><p>這個函式支援多種驗證方式，可以輸入切開或為切開的簽章，有前綴或沒前綴都可以。有多種輸入方式</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(<span class="attr">data</span>: string, <span class="attr">v</span>: string, <span class="attr">r</span>: string, <span class="attr">s</span>: string, <span class="attr">prefixed</span>:? boolean): string</span><br></pre></td></tr></table></figure><ul><li>data: 簽署的內容，0x 開頭為 bytes 二進位資料，或是文字內容。</li><li>v: 0x 開頭的字串。</li><li>r: 0x 開頭的字串。</li><li>s: 0x 開頭的字串。</li><li>prefixed: true 為沒有前綴，false 為使用前綴。預設 false</li><li>回傳值: 簽章人地址。</li></ul><p>或是未切開的簽章</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(<span class="attr">data</span>: string, <span class="attr">signature</span>: string, <span class="attr">prefixed</span>:? boolean): string</span><br></pre></td></tr></table></figure><ul><li>data: 簽署的內容，0x 開頭為 bytes 二進位資料，或是文字內容。</li><li>signature: 未切開的簽章，0x 開頭的字串。</li><li>prefixed: true 為沒有前綴，false 為使用前綴。預設 false</li><li>回傳值: 簽章人地址。</li></ul><p>或是物件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(<span class="attr">data</span>: <span class="title class_">SignatureObject</span>, <span class="attr">_</span>: string, <span class="attr">prefixed</span>:? boolean): string</span><br><span class="line"></span><br><span class="line"><span class="title class_">SignatureObject</span>: &#123;</span><br><span class="line">  <span class="attr">messageHash</span>: string;</span><br><span class="line">  <span class="attr">r</span>: string;</span><br><span class="line">  <span class="attr">s</span>: string;</span><br><span class="line">  <span class="attr">v</span>: string</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>data: 包含簽署內容和 vrs。</li><li>_: 無作用</li><li>prefixed: true 為沒有前綴，false 為使用前綴。預設 false</li><li>回傳值: 簽章人地址。</li></ul><p>對應 web3.eth.sign 之檢驗</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> v = <span class="string">&#x27;0x1b&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> r = <span class="string">&#x27;0xe1077fb9321c187d8a43926896abac5455ce6add269e098f855ff059d6b846a3&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> s = <span class="string">&#x27;0x56320be5f6d79c4d0e5583d6b9a2e50fae78f1fb5ff0553541e69c66dae2b2f8&#x27;</span>;</span><br><span class="line"><span class="comment">// 0xDD980c315dFA75682F04381E98ea38BD2A151540</span></span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(message, v, r, s, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> signature = <span class="string">&#x27;0xe1077fb9321c187d8a43926896abac5455ce6add269e098f855ff059d6b846a356320be5f6d79c4d0e5583d6b9a2e50fae78f1fb5ff0553541e69c66dae2b2f81b&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(message, signature, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> signatureObj = &#123;</span><br><span class="line">  v, r, s,</span><br><span class="line">  <span class="attr">messageHash</span>: message</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(signatureObj, <span class="string">&#x27;&#x27;</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>對應 web3.eth.accounts.sign 和 web3.eth.personal.sign 之檢驗</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> v = <span class="string">&#x27;0x1c&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> r = <span class="string">&#x27;0x03105c6f9bcc43236f5ef5e78038506c2551fc11d65701097295094c06c9d4f3&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> s = <span class="string">&#x27;0x0029ec14347d37d8115cebcf915dc8f6f74c011698d9b7aea15c184f2277197a&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(message, v, r, s);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> signature = <span class="string">&#x27;0x03105c6f9bcc43236f5ef5e78038506c2551fc11d65701097295094c06c9d4f30029ec14347d37d8115cebcf915dc8f6f74c011698d9b7aea15c184f2277197a1c&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(message, signature);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> signatureObj = &#123;</span><br><span class="line">  v, r, s,</span><br><span class="line">  <span class="attr">messageHash</span>: message</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(signatureObj);</span><br></pre></td></tr></table></figure><p>純文字的簽署內容</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;OK!&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> v = <span class="string">&#x27;0x1c&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> r = <span class="string">&#x27;0x7dff4feac0d0bf31d5b11ef3793bf9d00e7b9028eaaa9737f5079685ff435c9c&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> s = <span class="string">&#x27;0x7a22e79b7dab0b0d37524a0f9621d98b76fbc77b6402f87d142746eee61edcb2&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(message, v, r, s);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> signature = <span class="string">&#x27;0x7dff4feac0d0bf31d5b11ef3793bf9d00e7b9028eaaa9737f5079685ff435c9c7a22e79b7dab0b0d37524a0f9621d98b76fbc77b6402f87d142746eee61edcb21c&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(message, signature);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> signatureObj = &#123;</span><br><span class="line">  v, r, s,</span><br><span class="line">  <span class="attr">messageHash</span>: message</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> signer = web3.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="title function_">recover</span>(signatureObj);</span><br></pre></td></tr></table></figure><h3 id="web3-eth-personal-ecRecover"><a href="#web3-eth-personal-ecRecover" class="headerlink" title="web3.eth.personal.ecRecover"></a>web3.eth.personal.ecRecover</h3><p>這個函式只支援未切開的簽章，固定使用 EIP-191 前綴。瀏覽器錢包才能用。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">ecRecover</span>(<span class="attr">signedData</span>: string, <span class="attr">signature</span>: string): <span class="title class_">Promise</span>&lt;string&gt;</span><br></pre></td></tr></table></figure><ul><li>signedData: 簽署的內容，0x 開頭為 bytes 二進位資料，或是文字內容。</li><li>signature: 未切開的簽章，0x 開頭的字串。</li><li>回傳值: 為 Promise 物件，內容為簽章人地址。</li></ul><p>對應 web3.eth.accounts.sign 和 web3.eth.personal.sign 之檢驗</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;0xc1af4b94166cd32fc49b7b926cbb91ee421de2d04450e8ae57857b9b56ac7e53&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signature = <span class="string">&#x27;0x03105c6f9bcc43236f5ef5e78038506c2551fc11d65701097295094c06c9d4f30029ec14347d37d8115cebcf915dc8f6f74c011698d9b7aea15c184f2277197a1c&#x27;</span>;</span><br><span class="line"><span class="comment">// 0xdd980c315dfa75682f04381e98ea38bd2a151540</span></span><br><span class="line"><span class="keyword">const</span> signer = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">ecRecover</span>(message, signature);</span><br></pre></td></tr></table></figure><p>純文字的簽署內容</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">&#x27;OK!&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> signature = <span class="string">&#x27;0x7dff4feac0d0bf31d5b11ef3793bf9d00e7b9028eaaa9737f5079685ff435c9c7a22e79b7dab0b0d37524a0f9621d98b76fbc77b6402f87d142746eee61edcb21c&#x27;</span>;</span><br><span class="line"><span class="comment">// 0xdd980c315dfa75682f04381e98ea38bd2a151540</span></span><br><span class="line"><span class="keyword">const</span> signer = <span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">ecRecover</span>(message, signature);</span><br></pre></td></tr></table></figure><h3 id="簽名延展性-Signature-Malleability"><a href="#簽名延展性-Signature-Malleability" class="headerlink" title="簽名延展性 (Signature Malleability)"></a>簽名延展性 (Signature Malleability)</h3><p>Web3.js 同樣有<a href="../solidity-signature-malleability/">簽名延展性 (Signature Malleability)</a> 問題，一樣可以檢查 s 的值：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (s &gt; <span class="number">0x7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5D576E7357A4501DDFE92F46681B20A0n</span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;invalid s&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="總結"><a href="#總結" class="headerlink" title="總結"></a>總結</h2><ol><li><code>web3.eth.sign</code> 已過時不使用。</li><li>私鑰簽署使用 <code>web3.eth.accounts.sign</code>。</li><li>瀏覽器錢包簽署使用 <code>web3.personal.sign</code>。</li><li>檢驗簽章使用 <code>web3.eth.accounts.recover</code> 比較通用。</li></ol><h2 id="延伸閱讀"><a href="#延伸閱讀" class="headerlink" title="延伸閱讀"></a>延伸閱讀</h2><p><a href="../solidity-ecrecover/">Solidity 智能合約 - ecrecover 簽章檢驗</a><br><a href="../solidity-signature-malleability/">Solidity 智能合約 - 簽名延展性 (Signature Malleability)</a><br><a href="../using-ethers-js-to-sign-and-recover/">使用 Ethers.js 簽章與檢驗</a><br><a href="../using-web3-js-to-sign-eip-712-typed-structured-data/">使用 Web3.js 進行 EIP-712 類型結構化資料簽名</a></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://blog.emn178.cc">小殘</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章連結: </span><span class="post-copyright-info"><a href="https://blog.emn178.cc/zh-TW/post/using-web3-js-to-sign-and-recover/">https://blog.emn178.cc/zh-TW/post/using-web3-js-to-sign-and-recover/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版權聲明: </span><span class="post-copyright-info">本部落格所有文章除特別聲明外，均採用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 許可協議。轉載請註明來自 <a href="https://blog.emn178.cc" target="_blank">小殘的程式光廊</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/images/zh-TW/post/2023/using-web3-js-to-parse-custom-error/web3js.jpg" data-initialized="true"><a class="social-share-icon icon-facebook" href="#" aria-label="share to facebook"></a><a class="social-share-icon icon-twitter" href="#" aria-label="share to twitter"></a><a class="social-share-icon icon-wechat" href="#" aria-label="share to wechat"></a><a class="social-share-icon icon-weibo" href="#" aria-label="share to weibo"></a><a class="social-share-icon icon-qq" href="#" aria-label="share to qq"></a></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/zh-TW/post/solidity-signature-malleability/" title="Solidity 智能合約 - 簽名延展性 (Signature Malleability)"><img class="cover" src="/images/loading.svg" data-src="/images/zh-TW/post/2018/solidity-gas-optimization-variable-ordering/solidity-logo.svg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><noscript><img class="cover" src="/images/zh-TW/post/2018/solidity-gas-optimization-variable-ordering/solidity-logo.svg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"></noscript><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Solidity 智能合約 - 簽名延展性 (Signature Malleability)</div></div></a></div><div class="next-post pull-right"><a href="/zh-TW/post/using-ethers-js-to-sign-and-recover/" title="使用 Ethers.js 簽章與檢驗"><img class="cover" src="/images/loading.svg" data-src="/images/zh-TW/post/2023/ethers-js-parse-custom-error/ethers.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><noscript><img class="cover" src="/images/zh-TW/post/2023/ethers-js-parse-custom-error/ethers.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"></noscript><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">使用 Ethers.js 簽章與檢驗</div></div></a></div></nav><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/loading.svg" data-src="/images/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><noscript><img src="/images/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></noscript></div><div class="author-info__name">小殘</div><div class="author-info__description">小殘的部落格，分享 AI 應用和程式技術文章之外，也記錄旅遊、生活與各種其他資訊。</div></div><div class="card-info-data site-data is-center"><a href="/zh-TW/archives/"><div class="headline">文章</div><div class="length-num">131</div></a><a href="/zh-TW/tags/"><div class="headline">標籤</div><div class="length-num">20</div></a><a href="/zh-TW/categories/"><div class="headline">分類</div><div class="length-num">11</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目錄</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B0%BD%E7%AB%A0"><span class="toc-number">1.</span> <span class="toc-text">簽章</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#web3-eth-sign"><span class="toc-number">1.1.</span> <span class="toc-text">web3.eth.sign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web3-eth-accounts-sign"><span class="toc-number">1.2.</span> <span class="toc-text">web3.eth.accounts.sign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web3-eth-personal-sign"><span class="toc-number">1.3.</span> <span class="toc-text">web3.eth.personal.sign</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B0%BD%E7%AB%A0%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">簽章格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AA%A2%E9%A9%97%E7%B0%BD%E7%AB%A0"><span class="toc-number">3.</span> <span class="toc-text">檢驗簽章</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#web3-eth-accounts-recover"><span class="toc-number">3.1.</span> <span class="toc-text">web3.eth.accounts.recover</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web3-eth-personal-ecRecover"><span class="toc-number">3.2.</span> <span class="toc-text">web3.eth.personal.ecRecover</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B0%BD%E5%90%8D%E5%BB%B6%E5%B1%95%E6%80%A7-Signature-Malleability"><span class="toc-number">3.3.</span> <span class="toc-text">簽名延展性 (Signature Malleability)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B8%BD%E7%B5%90"><span class="toc-number">4.</span> <span class="toc-text">總結</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80"><span class="toc-number">5.</span> <span class="toc-text">延伸閱讀</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/zh-TW/post/stable-diffusion-webui-tiling/" title="Stable Diffusion 教學 - Tiling"><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/stable-diffusion-webui-tiling/flowers-512.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Stable Diffusion 教學 - Tiling"><noscript><img src="/images/zh-TW/post/2023/stable-diffusion-webui-tiling/flowers-512.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Stable Diffusion 教學 - Tiling"></noscript></a><div class="content"><a class="title" href="/zh-TW/post/stable-diffusion-webui-tiling/" title="Stable Diffusion 教學 - Tiling">Stable Diffusion 教學 - Tiling</a><time datetime="2023-10-09T02:10:14.000Z" title="發表於 2023-10-09 10:10:14">2023-10-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/zh-TW/post/stable-diffusion-webui-restore-faces/" title="Stable Diffusion 教學 - Restore faces"><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/stable-diffusion-webui-restore-faces/photorealistic/origin.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Stable Diffusion 教學 - Restore faces"><noscript><img src="/images/zh-TW/post/2023/stable-diffusion-webui-restore-faces/photorealistic/origin.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Stable Diffusion 教學 - Restore faces"></noscript></a><div class="content"><a class="title" href="/zh-TW/post/stable-diffusion-webui-restore-faces/" title="Stable Diffusion 教學 - Restore faces">Stable Diffusion 教學 - Restore faces</a><time datetime="2023-10-04T15:02:55.000Z" title="發表於 2023-10-04 23:02:55">2023-10-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/zh-TW/post/using-ethers-js-to-sign-eip-712-typed-structured-data/" title="使用 Ethers.js 進行 EIP-712 類型結構化資料簽名"><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/ethers-js-parse-custom-error/ethers.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="使用 Ethers.js 進行 EIP-712 類型結構化資料簽名"><noscript><img src="/images/zh-TW/post/2023/ethers-js-parse-custom-error/ethers.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="使用 Ethers.js 進行 EIP-712 類型結構化資料簽名"></noscript></a><div class="content"><a class="title" href="/zh-TW/post/using-ethers-js-to-sign-eip-712-typed-structured-data/" title="使用 Ethers.js 進行 EIP-712 類型結構化資料簽名">使用 Ethers.js 進行 EIP-712 類型結構化資料簽名</a><time datetime="2023-09-26T00:36:07.000Z" title="發表於 2023-09-26 08:36:07">2023-09-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/zh-TW/post/using-web3-js-to-sign-and-recover-eip-712-typed-structured-data/" title="使用 Web3.js 進行 EIP-712 類型結構化資料簽名與檢驗"><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/using-web3-js-to-parse-custom-error/web3js.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="使用 Web3.js 進行 EIP-712 類型結構化資料簽名與檢驗"><noscript><img src="/images/zh-TW/post/2023/using-web3-js-to-parse-custom-error/web3js.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="使用 Web3.js 進行 EIP-712 類型結構化資料簽名與檢驗"></noscript></a><div class="content"><a class="title" href="/zh-TW/post/using-web3-js-to-sign-and-recover-eip-712-typed-structured-data/" title="使用 Web3.js 進行 EIP-712 類型結構化資料簽名與檢驗">使用 Web3.js 進行 EIP-712 類型結構化資料簽名與檢驗</a><time datetime="2023-09-24T12:23:59.000Z" title="發表於 2023-09-24 20:23:59">2023-09-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/zh-TW/post/find-kth-largest-number-in-an-array/" title="在陣列中找出第 K 大的數字"><img src="/images/loading.svg" data-src="/images/zh-TW/post/2023/find-kth-largest-number-in-an-array/00033-17460635.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="在陣列中找出第 K 大的數字"><noscript><img src="/images/zh-TW/post/2023/find-kth-largest-number-in-an-array/00033-17460635.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="在陣列中找出第 K 大的數字"></noscript></a><div class="content"><a class="title" href="/zh-TW/post/find-kth-largest-number-in-an-array/" title="在陣列中找出第 K 大的數字">在陣列中找出第 K 大的數字</a><time datetime="2023-09-23T01:46:27.000Z" title="發表於 2023-09-23 09:46:27">2023-09-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2010 - 2023 By 小殘</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="閱讀模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="淺色和深色模式轉換"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="單欄和雙欄切換"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="設定"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目錄"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直達評論"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到頂部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4"></script><script src="/js/main.js?v=12"></script><div class="js-pjax"><script>function loadDisqus(){var e,t,s=function(){this.page.url="https://blog.emn178.cc/zh-TW/post/using-web3-js-to-sign-and-recover/",this.page.identifier="/zh-TW/post/using-web3-js-to-sign-and-recover/",this.page.title="使用 Web3.js 簽章與檢驗"};window.disqusReset=()=>{DISQUS.reset({reload:!0,config:s})},window.DISQUS?disqusReset():(e=document,(t=e.createElement("script")).src="https://emn178.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)),document.getElementById("darkmode").addEventListener("click",()=>{setTimeout(()=>window.disqusReset(),200)})}{function loadOtherComment(){loadDisqus()}btf.loadComment(document.getElementById("disqus_thread"),loadDisqus)}</script></div></div></body></html>